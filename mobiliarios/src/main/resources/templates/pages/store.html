<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de mobiliario | FURENT</title>
    <!-- Script inline para aplicar tema ANTES de cargar CSS y evitar parpadeos -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            const bg = theme === 'dark' ? '#0f172a' : '#ffffff';
            const style = document.createElement('style');
            style.id = 'pre-theme-style';
            style.textContent = `html,body{background:${bg};}`;
            document.head.appendChild(style);
            if (theme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
            }
        })();
    </script>
    <link rel="stylesheet" th:href="@{/css/normalize.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <link rel="stylesheet" th:href="@{/css/estilos.css}">
    <link rel="stylesheet" th:href="@{/css/modern-styles.css}">
    <link rel="stylesheet" th:href="@{/css/dark-mode.css}">
    <link rel="stylesheet" th:href="@{/css/cart-preview.css}">
    <link rel="stylesheet" th:href="@{/css/header-adjustments.css}">
    <link rel="stylesheet" th:href="@{/css/product-cards-ultra.css}">
    <link rel="stylesheet" th:href="@{/css/payment-notifications.css}">
    <link rel="stylesheet" th:href="@{/css/resenas.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script th:src="@{/js/theme-toggle.js}"></script>
    <style>
        /* ========== SELECTOR MÚLTIPLE STYLES ========== */
        .multi-select-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
            width: 32px;
            height: 32px;
            cursor: pointer;
            appearance: none;
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .multi-select-checkbox:hover {
            border-color: #8cbc00;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(140, 188, 0, 0.3);
        }
        
        .multi-select-checkbox:checked {
            background: linear-gradient(135deg, #8cbc00 0%, #037bc0 100%);
            border-color: #8cbc00;
            animation: checkboxPop 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        .multi-select-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            font-weight: bold;
            animation: checkAppear 0.3s ease 0.1s both;
        }
        
        .multi-select-checkbox:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: #cbd5e0;
            background: rgba(203, 213, 224, 0.5);
        }
        
        .multi-select-checkbox:disabled:hover {
            transform: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        @keyframes checkboxPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes checkAppear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .product-card-modern.selected {
            transform: translateY(-8px);
            box-shadow: 0 12px 35px rgba(140, 188, 0, 0.3) !important;
            border: 3px solid #8cbc00;
        }
        
        /* Floating Action Bar */
        .multi-select-action-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 20px 35px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 0 1px rgba(140,188,0,0.3);
            display: flex;
            align-items: center;
            gap: 25px;
            z-index: 9999;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(140,188,0,0.2);
        }
        
        .multi-select-action-bar.active {
            transform: translateX(-50%) translateY(0);
            animation: slideUpBounce 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        @keyframes slideUpBounce {
            0% {
                transform: translateX(-50%) translateY(150px);
                opacity: 0;
            }
            60% {
                transform: translateX(-50%) translateY(-10px);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .multi-select-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
            font-weight: 600;
            font-size: 15px;
        }
        
        .multi-select-info i {
            font-size: 24px;
            color: #8cbc00;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .multi-select-count {
            background: linear-gradient(135deg, #8cbc00 0%, #037bc0 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(140, 188, 0, 0.3);
            animation: countPulse 1.5s infinite;
        }
        
        @keyframes countPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(140, 188, 0, 0.3);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 6px 20px rgba(140, 188, 0, 0.5);
            }
        }
        
        .multi-select-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn-add-selected,
        .btn-clear-selection {
            padding: 12px 28px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-add-selected {
            background: linear-gradient(135deg, #8cbc00 0%, #6fa000 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(140, 188, 0, 0.4);
        }
        
        .btn-add-selected:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 30px rgba(140, 188, 0, 0.6);
            background: linear-gradient(135deg, #9dd100 0%, #8cbc00 100%);
        }
        
        .btn-add-selected:active {
            transform: translateY(-1px) scale(1);
        }
        
        .btn-add-selected i {
            animation: wiggle 1s infinite;
        }
        
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        .btn-clear-selection {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 2px solid rgba(239, 68, 68, 0.3);
        }
        
        .btn-clear-selection:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: translateY(-3px) scale(1.05);
        }
        
        .btn-clear-selection:active {
            transform: translateY(-1px) scale(1);
        }
        
        .btn-clear-selection:hover i {
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Dark mode */
        body.dark-mode .multi-select-checkbox {
            background: rgba(30, 41, 59, 0.95);
            border-color: rgba(140, 188, 0, 0.3);
        }
        
        body.dark-mode .multi-select-checkbox:disabled {
            background: rgba(15, 23, 42, 0.5);
            border-color: rgba(100, 116, 139, 0.3);
        }
        
        body.dark-mode .multi-select-action-bar {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
            border-color: rgba(140, 188, 0, 0.3);
            box-shadow: 0 20px 60px rgba(0,0,0,0.7), 0 0 0 1px rgba(140,188,0,0.4);
        }
        
        body.dark-mode .multi-select-info span {
            color: #e5e7eb;
        }
        
        /* Dark mode para el modal de SweetAlert */
        .swal2-popup.swal2-modal {
            background-color: #fff;
        }
        
        body.dark-mode .swal2-popup {
            background: #1e293b !important;
            color: #e5e7eb !important;
        }
        
        body.dark-mode .swal2-title {
            color: #e5e7eb !important;
        }
        
        body.dark-mode .swal2-html-container {
            color: #cbd5e1 !important;
        }
        
        body.dark-mode .swal2-input {
            background: #0f172a !important;
            border-color: rgba(140, 188, 0, 0.3) !important;
            color: #e5e7eb !important;
        }
        
        body.dark-mode .swal2-input:focus {
            border-color: #8cbc00 !important;
            box-shadow: 0 0 0 3px rgba(140, 188, 0, 0.2) !important;
        }
        
        body.dark-mode .swal2-confirm {
            background: linear-gradient(135deg, #8cbc00, #6fa000) !important;
        }
        
        body.dark-mode .swal2-cancel {
            background: rgba(239, 68, 68, 0.2) !important;
            border: 2px solid #dc2626 !important;
            color: #ef4444 !important;
        }
        
        body.dark-mode .swal2-cancel:hover {
            background: #dc2626 !important;
            color: white !important;
        }
        
        /* Ajustes para el checkbox en modo oscuro */
        body.dark-mode .product-card-modern.selected {
            border-color: #8cbc00;
            box-shadow: 0 12px 35px rgba(140, 188, 0, 0.4) !important;
        }
        
        /* Estilos para botones modernos del modal de validación */
        .swal2-confirm-modern {
            padding: 14px 35px !important;
            font-weight: 700 !important;
            font-size: 16px !important;
            border-radius: 12px !important;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            box-shadow: 0 6px 20px rgba(140, 188, 0, 0.4) !important;
            border: none !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .swal2-confirm-modern::before {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            width: 0 !important;
            height: 0 !important;
            border-radius: 50% !important;
            background: rgba(255, 255, 255, 0.3) !important;
            transform: translate(-50%, -50%) !important;
            transition: width 0.6s, height 0.6s !important;
        }
        
        .swal2-confirm-modern:hover::before {
            width: 300px !important;
            height: 300px !important;
        }
        
        .swal2-confirm-modern:hover {
            transform: translateY(-4px) scale(1.05) !important;
            box-shadow: 0 10px 30px rgba(140, 188, 0, 0.6) !important;
            background: linear-gradient(135deg, #9dcd00, #8cbc00) !important;
        }
        
        .swal2-confirm-modern:active {
            transform: translateY(-1px) scale(1.02) !important;
            box-shadow: 0 5px 15px rgba(140, 188, 0, 0.5) !important;
        }
        
        .swal2-cancel-modern {
            padding: 14px 35px !important;
            font-weight: 700 !important;
            font-size: 16px !important;
            border-radius: 12px !important;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            border: 2px solid #9ca3af !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .swal2-cancel-modern::before {
            content: '' !important;
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            width: 0 !important;
            height: 0 !important;
            border-radius: 50% !important;
            background: rgba(255, 255, 255, 0.1) !important;
            transform: translate(-50%, -50%) !important;
            transition: width 0.6s, height 0.6s !important;
        }
        
        .swal2-cancel-modern:hover::before {
            width: 300px !important;
            height: 300px !important;
        }
        
        .swal2-cancel-modern:hover {
            transform: translateY(-4px) scale(1.05) !important;
            background-color: #4b5563 !important;
            border-color: #4b5563 !important;
            box-shadow: 0 8px 25px rgba(75, 85, 99, 0.4) !important;
        }
        
        .swal2-cancel-modern:active {
            transform: translateY(-1px) scale(1.02) !important;
        }
        
        /* ========== MODERN FILTERS STYLES ========== */
        .store-filters-modern {
            background: linear-gradient(135deg, rgba(140, 188, 0, 0.03), rgba(3, 123, 192, 0.03));
            border-radius: 20px;
            padding: 30px 50px;
            margin-bottom: 40px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 2px solid rgba(140, 188, 0, 0.1);
            animation: slideInDown 0.6s ease-out;
            transition: all 0.3s ease;
        }

        .store-filters-modern:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        /* Search Box */
        .search-box-modern {
            margin-bottom: 25px;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-icon {
            position: absolute;
            left: 20px;
            font-size: 20px;
            color: #8cbc00;
            z-index: 2;
            transition: all 0.3s ease;
        }

        #searchProduct {
            width: 100%;
            padding: 18px 60px 18px 55px;
            border: 3px solid rgba(140, 188, 0, 0.2);
            border-radius: 50px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        #searchProduct:focus {
            outline: none;
            border-color: #8cbc00;
            box-shadow: 0 0 0 6px rgba(140, 188, 0, 0.15), 0 8px 25px rgba(140, 188, 0, 0.2);
            transform: translateY(-2px);
        }

        #searchProduct::placeholder {
            color: #9ca3af;
        }

        .btn-clear-search-modern {
            position: absolute;
            right: 15px;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px;
            display: flex;
            align-items: center;
            z-index: 2;
        }

        .btn-clear-search-modern:hover {
            color: #ef4444;
            transform: scale(1.15) rotate(90deg);
        }

        /* Filters Row */
        .filters-row-modern {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-item-modern {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-item-modern label {
            font-size: 13px;
            font-weight: 700;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-item-modern label i {
            color: #8cbc00;
            font-size: 15px;
        }

        .select-modern {
            padding: 14px 18px;
            border: 2px solid rgba(140, 188, 0, 0.2);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%238cbc00' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            padding-right: 45px;
        }

        .select-modern:hover {
            border-color: #8cbc00;
            box-shadow: 0 4px 12px rgba(140, 188, 0, 0.15);
        }

        .select-modern:focus {
            outline: none;
            border-color: #8cbc00;
            box-shadow: 0 0 0 4px rgba(140, 188, 0, 0.1);
        }

        /* Reset Button */
        .btn-reset-filters-modern {
            padding: 14px 24px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            color: #dc2626;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            align-self: flex-end;
        }

        .btn-reset-filters-modern:hover {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-color: #dc2626;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-reset-filters-modern:active {
            transform: translateY(-1px);
        }

        .btn-reset-filters-modern i {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .btn-reset-filters-modern:hover i {
            transform: rotate(180deg);
        }

        /* Results Info */
        .results-info-modern {
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(140, 188, 0, 0.1), rgba(3, 123, 192, 0.1));
            border-radius: 12px;
            border-left: 5px solid #8cbc00;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            animation: fadeIn 0.5s ease;
            transition: border-left-color 0.3s ease;
        }

        .results-info-modern .bi,
        .results-info-modern i,
        .results-info-modern [class^="bi-"],
        .results-info-modern [class*=" bi-"] {
            color: #8cbc00 !important;
            font-size: 20px !important;
            font-style: normal !important;
            animation: pulse 2s ease-in-out infinite;
            transition: color 0.3s ease;
            border: 0 !important;
            outline: 0 !important;
            box-shadow: none !important;
            background: none !important;
            background-color: transparent !important;
            background-image: none !important;
            display: inline-block !important;
            line-height: 1 !important;
            padding: 0 !important;
            margin: 0 !important;
            width: auto !important;
            height: auto !important;
            min-width: 0 !important;
            min-height: 0 !important;
            vertical-align: middle;
        }
        
        .results-info-modern .bi::before,
        .results-info-modern .bi::after,
        .results-info-modern i::before,
        .results-info-modern i::after {
            background: none !important;
            background-color: transparent !important;
            background-image: none !important;
            border: 0 !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Dark Mode Adaptations */
        body.dark-mode .store-filters-modern {
            background: linear-gradient(135deg, rgba(140, 188, 0, 0.08), rgba(3, 123, 192, 0.08));
            border-color: rgba(140, 188, 0, 0.2);
        }

        body.dark-mode #searchProduct,
        body.dark-mode .select-modern {
            background: #1f2937;
            color: #e5e7eb;
            border-color: rgba(140, 188, 0, 0.3);
        }

        body.dark-mode #searchProduct::placeholder {
            color: #6b7280;
        }

        body.dark-mode .filter-item-modern label {
            color: #9ca3af;
        }

        body.dark-mode .results-info-modern {
            background: linear-gradient(135deg, rgba(140, 188, 0, 0.15), rgba(3, 123, 192, 0.15));
            color: #e5e7eb;
        }

        /* Animations */
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Product Animations */
        .product {
            animation: fadeInUp 0.6s ease-out backwards;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            will-change: opacity, transform;
        }

        .product:nth-child(1) { animation-delay: 0.1s; }
        .product:nth-child(2) { animation-delay: 0.15s; }
        .product:nth-child(3) { animation-delay: 0.2s; }
        .product:nth-child(4) { animation-delay: 0.25s; }
        .product:nth-child(5) { animation-delay: 0.3s; }
        .product:nth-child(6) { animation-delay: 0.35s; }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .store-filters-modern {
                padding: 20px 40px;
            }

            .filters-row-modern {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            #searchProduct {
                padding: 15px 50px 15px 50px;
                font-size: 14px;
            }

            .btn-reset-filters-modern {
                width: 100%;
                justify-content: center;
            }

            .results-info-modern {
                font-size: 13px;
            }
        }

        /* ========== END MODERN FILTERS STYLES ========== */
        
        /* ========== LOAD MORE BUTTON STYLES ========== */
        .load-more-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 40px 0;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        .btn-load-more {
            padding: 16px 40px;
            background: linear-gradient(135deg, #8cbc00 0%, #037bc0 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 25px rgba(140, 188, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-load-more::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-load-more:hover::before {
            width: 400px;
            height: 400px;
        }
        
        .btn-load-more:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(140, 188, 0, 0.5);
        }
        
        .btn-load-more:active {
            transform: translateY(-2px);
        }
        
        .btn-load-more i {
            font-size: 1.3rem;
            transition: transform 0.3s ease;
        }
        
        .btn-load-more:hover i {
            transform: translateY(5px);
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(8px); }
        }
        
        /* Botón Ver Menos */
        .btn-load-less {
            padding: 16px 40px;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 25px rgba(100, 116, 139, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-load-less::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-load-less:hover::before {
            width: 400px;
            height: 400px;
        }
        
        .btn-load-less:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(100, 116, 139, 0.5);
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
        }
        
        .btn-load-less:active {
            transform: translateY(-2px);
        }
        
        .btn-load-less i {
            font-size: 1.3rem;
            transition: transform 0.3s ease;
        }
        
        .btn-load-less:hover i {
            transform: translateY(-5px);
            animation: bounceUp 1s ease infinite;
        }
        
        @keyframes bounceUp {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .load-more-info {
            font-size: 0.95rem;
            color: #64748b;
            font-weight: 500;
            margin: 0;
        }
        
        .load-more-info span {
            font-weight: 700;
            color: #8cbc00;
        }
        
        body.dark-mode .load-more-info {
            color: #94a3b8;
        }
        
        body.dark-mode .load-more-info span {
            color: #8cbc00;
        }
        
        @media (max-width: 768px) {
            .btn-load-more {
                padding: 14px 32px;
                font-size: 1rem;
            }
            
            .load-more-container {
                margin: 30px 0;
                padding: 20px;
            }
        }
        /* ========== END LOAD MORE BUTTON STYLES ========== */
        
        /* ========== TOAST COMPACT STYLES ========== */
        .toast-title-compact {
            font-size: 13px !important;
            font-weight: 600 !important;
            text-align: center !important;
            line-height: 1.3 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .swal2-toast .swal2-icon {
            width: 24px !important;
            height: 24px !important;
            margin: 0 8px 0 0 !important;
        }
        
        .swal2-toast .swal2-icon .swal2-icon-content {
            font-size: 16px !important;
        }
        
        .swal2-toast {
            align-items: center !important;
            padding: 10px 12px !important;
        }
        
        .swal2-toast .swal2-title {
            margin: 0 !important;
        }
        /* ========== END TOAST COMPACT STYLES ========== */
        
        /* Estilos para botón deshabilitado cuando no hay stock */
        .btn-add-cart.btn-disabled,
        .btn-add-cart:disabled {
            background: #9ca3af !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        
        .btn-add-cart.btn-disabled:hover,
        .btn-add-cart:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
            background: #9ca3af !important;
        }
        
        .product-stock.stock-unavailable {
            font-weight: 600;
        }
        
        .product-stock.stock-available {
            font-weight: 600;
        }
        
        /* Estilos para overlay de SIN STOCK */
        .product-image-container {
            position: relative;
            overflow: hidden;
        }
        
        .out-of-stock-image {
            filter: grayscale(50%) brightness(0.7);
        }
        
        .out-of-stock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.85) 0%, rgba(220, 38, 38, 0.9) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            animation: fadeInOverlay 0.5s ease-in-out;
        }
        
        .out-of-stock-badge {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: pulseScale 2s ease-in-out infinite;
            transform-origin: center;
        }
        
        .out-of-stock-badge i {
            font-size: 48px;
            color: #ef4444;
            animation: rotateIcon 3s linear infinite;
        }
        
        .out-of-stock-badge span {
            font-size: 20px;
            font-weight: 800;
            color: #dc2626;
            letter-spacing: 2px;
            text-transform: uppercase;
            animation: textGlow 1.5s ease-in-out infinite alternate;
        }
        
        /* Animaciones */
        @keyframes fadeInOverlay {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes pulseScale {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes rotateIcon {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        @keyframes textGlow {
            from {
                text-shadow: 0 0 5px rgba(239, 68, 68, 0.3);
            }
            to {
                text-shadow: 0 0 20px rgba(239, 68, 68, 0.8), 0 0 30px rgba(239, 68, 68, 0.5);
            }
        }
        
        /* Ajuste para que el botón de ver imagen no se superponga */
        .btn-view-image {
            z-index: 15;
        }
        
        /* Botón de favoritos */
        .btn-favorite {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 20;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn-favorite i {
            font-size: 22px;
            color: #ff4757;
            transition: all 0.3s;
        }
        .btn-favorite:hover {
            background: white;
            transform: scale(1.1);
        }
        .btn-favorite.active {
            background: #ff4757;
        }
        .btn-favorite.active i {
            color: white;
            animation: heartPulse 0.5s ease;
        }
        
        @keyframes heartPulse {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.2); }
        }
        
        /* Botón de favoritos deshabilitado (sin stock) */
        .btn-favorite.btn-favorite-disabled,
        .btn-favorite:disabled {
            background: rgba(156, 163, 175, 0.5) !important;
            cursor: not-allowed !important;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .btn-favorite.btn-favorite-disabled i,
        .btn-favorite:disabled i {
            color: #9ca3af !important;
        }
        
        .btn-favorite.btn-favorite-disabled:hover,
        .btn-favorite:disabled:hover {
            transform: none !important;
            background: rgba(156, 163, 175, 0.5) !important;
        }
        
        /* Estilos para productos sin stock - reducir opacidad */
        .product-card-modern.product-out-of-stock {
            opacity: 0.75;
            transition: opacity 0.3s ease;
        }
        
        .product-card-modern.product-out-of-stock:hover {
            opacity: 0.85;
        }
        
        /* Filtro de imagen para productos sin stock */
        .out-of-stock-filter {
            filter: grayscale(40%) brightness(0.85);
        }
        
        /* ========== RATING STARS IN PRODUCT CARDS ========== */
        .product-rating-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 12px 0;
            padding: 10px 0;
            border-top: 1px solid rgba(0,0,0,0.06);
            border-bottom: 1px solid rgba(0,0,0,0.06);
            animation: fadeInUp 0.6s ease-out;
        }
        
        .product-stars-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .product-stars {
            display: inline-flex;
            gap: 3px;
            font-size: 16px;
        }
        
        .product-star {
            color: #ddd;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-block;
        }
        
        .product-star.filled {
            color: #ffc107;
            animation: starPop 0.5s ease-out;
        }
        
        .product-star.half {
            position: relative;
            color: #ddd;
        }
        
        .product-star.half::before {
            content: '★';
            position: absolute;
            left: 0;
            color: #ffc107;
            overflow: hidden;
            width: 50%;
        }
        
        @keyframes starPop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .product-rating-number {
            font-size: 14px;
            font-weight: 700;
            color: #2c3e50;
            margin-left: 2px;
        }
        
        .product-rating-count {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .product-rating-badge {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.5);
            }
        }
        
        .product-rating-badge i {
            font-size: 11px;
        }
        
        /* Hover effect on product card */
        .product-card-modern:hover .product-star.filled {
            transform: scale(1.15) rotate(5deg);
            filter: brightness(1.2);
        }
        
        /* No rating state */
        .product-no-rating {
            font-size: 12px;
            color: #95a5a6;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .product-no-rating i {
            font-size: 14px;
        }
        
        /* Dark mode */
        body.dark-mode .product-rating-container {
            border-color: rgba(255,255,255,0.1);
        }
        
        body.dark-mode .product-rating-number {
            color: #e0e0e0;
        }
        
        body.dark-mode .product-rating-count {
            color: #95a5a6;
        }
        
        body.dark-mode .product-no-rating {
            color: #7f8c8d;
        }
        
        /* ========== BUTTON VER RESEÑAS ========== */
        .btn-ver-resenas {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #8cbc00 0%, #7aa600 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(140, 188, 0, 0.2);
        }
        
        .btn-ver-resenas:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(140, 188, 0, 0.35);
        }
        
        .btn-ver-resenas:active {
            transform: translateY(0);
        }
        
        .btn-ver-resenas i {
            font-size: 13px;
        }
        
        .btn-ver-resenas .resenas-count {
            font-weight: 700;
        }
        
        .btn-ver-resenas.sin-resenas {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .btn-ver-resenas.sin-resenas:hover {
            transform: none;
            box-shadow: 0 2px 6px rgba(148, 163, 184, 0.2);
        }
        
        /* Dark mode */
        body.dark-mode .btn-ver-resenas {
            box-shadow: 0 2px 6px rgba(140, 188, 0, 0.3);
        }
        
        body.dark-mode .btn-ver-resenas:hover {
            box-shadow: 0 4px 12px rgba(140, 188, 0, 0.5);
        }
        
        /* ========== PANEL MODAL DE RESEÑAS ========== */
        .resenas-panel-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .resenas-panel-modal.active {
            display: flex;
            opacity: 1;
        }
        
        .resenas-panel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }
        
        .resenas-panel-container {
            position: relative;
            z-index: 2;
            background: white;
            border-radius: 24px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .resenas-panel-modal.active .resenas-panel-container {
            transform: scale(1) translateY(0);
        }
        
        /* Header del Panel */
        .resenas-panel-header {
            background: linear-gradient(135deg, #8cbc00 0%, #6fa000 100%);
            padding: 25px 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .resenas-panel-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -5%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            animation: float 8s ease-in-out infinite;
        }
        
        .resenas-panel-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .resenas-panel-icon i {
            font-size: 24px;
            color: white;
        }
        
        .resenas-panel-title {
            flex: 1;
        }
        
        .resenas-panel-title h3 {
            margin: 0;
            font-size: 22px;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .resenas-panel-title p {
            margin: 4px 0 0 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .resenas-panel-close {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .resenas-panel-close i {
            font-size: 18px;
            color: white;
            transition: transform 0.3s ease;
        }
        
        .resenas-panel-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .resenas-panel-close:hover i {
            transform: rotate(90deg);
        }
        
        /* Body del Panel */
        .resenas-panel-body {
            padding: 25px 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .resenas-panel-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .resenas-panel-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        
        .resenas-panel-body::-webkit-scrollbar-thumb {
            background: #8cbc00;
            border-radius: 10px;
        }
        
        /* Mensaje sin reseñas */
        .resenas-empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .resenas-empty-state i {
            font-size: 64px;
            color: #cbd5e1;
            margin-bottom: 15px;
        }
        
        .resenas-empty-state h4 {
            margin: 0 0 8px 0;
            font-size: 20px;
            font-weight: 700;
            color: #475569;
        }
        
        .resenas-empty-state p {
            margin: 0;
            font-size: 14px;
            color: #94a3b8;
        }
        
        /* Tarjeta de Reseña */
        .resena-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #8cbc00;
            transition: all 0.3s ease;
            animation: slideInUp 0.4s ease-out backwards;
        }
        
        .resena-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .resena-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .resena-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .resena-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8cbc00 0%, #037bc0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(140, 188, 0, 0.3);
        }
        
        .resena-user-name {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }
        
        .resena-date {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 2px;
        }
        
        .resena-rating {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .resena-stars {
            font-size: 16px;
            color: #fbbf24;
            letter-spacing: 2px;
        }
        
        .resena-score {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            background: rgba(251, 191, 36, 0.1);
            padding: 4px 10px;
            border-radius: 8px;
        }
        
        .resena-comment {
            margin: 12px 0 0 0;
            padding: 14px 16px;
            background: white;
            border-radius: 12px;
            position: relative;
            border-left: 3px solid rgba(140, 188, 0, 0.3);
        }
        
        .resena-comment i.bi-quote {
            position: absolute;
            top: 8px;
            left: 10px;
            font-size: 24px;
            color: rgba(140, 188, 0, 0.1);
        }
        
        .resena-comment p {
            margin: 0;
            padding-left: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #475569;
            font-style: italic;
        }
        
        /* Dark mode */
        body.dark-mode .resenas-panel-container {
            background: #1e293b;
        }
        
        body.dark-mode .resenas-panel-body::-webkit-scrollbar-track {
            background: #0f172a;
        }
        
        body.dark-mode .resena-item {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
        }
        
        body.dark-mode .resena-user-name {
            color: #e2e8f0;
        }
        
        body.dark-mode .resena-score {
            color: #e2e8f0;
        }
        
        body.dark-mode .resena-comment {
            background: #0f172a;
        }
        
        body.dark-mode .resena-comment p {
            color: #cbd5e1;
        }
        
        body.dark-mode .resenas-empty-state h4 {
            color: #e2e8f0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .resenas-panel-container {
                width: 95%;
                max-height: 90vh;
            }
            
            .resenas-panel-header {
                padding: 20px;
            }
            
            .resenas-panel-title h3 {
                font-size: 18px;
            }
            
            .resenas-panel-body {
                padding: 20px;
            }
            
            .resena-item {
                padding: 16px;
            }
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container top-bar-content">
            <div class="contact-info">
                <span><i class="bi bi-telephone"></i> +57 300 123 4567</span>
                <span><i class="bi bi-envelope"></i> info@furniturerent.com</span>
            </div>
            <div class="social-links">
                <a href="#"><i class="bi bi-facebook"></i></a>
                <a href="#"><i class="bi bi-instagram"></i></a>
                <a href="#"><i class="bi bi-twitter"></i></a>
                <a href="#"><i class="bi bi-linkedin"></i></a>
            </div>
        </div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <div class="container header-content">
            <a href="/" class="logo" aria-label="Ir al inicio">
                <i class="bi bi-house-heart"></i>
                <span>FU<strong>RENT</strong></span>
            </a>

            <nav class="nav-principal">
                <a href="/">Inicio</a>
                <a href="/about">Nosotros</a>
                <a href="/store" class="active">Alquilar</a>
                <a href="/contact">Contacto</a>
                <a th:if="${session.usuario}" href="/alquiler/mis-alquileres">
                    <i class="bi bi-calendar-check"></i> Mis alquileres
                </a>
                <a th:if="${session.usuario}" href="/favoritos">
                    <i class="bi bi-heart-fill"></i> Favoritos
                </a>
            </nav>
            
            <!-- Menú de usuario logueado -->
            <div class="user-menu" th:if="${session.usuario}">
                <div class="user-menu-toggle">
                    <div class="user-avatar" th:text="${#strings.substring(session.usuarioNombre, 0, 1)}">U</div>
                    <span th:text="${session.usuarioNombre}">Usuario</span>
                    <i class="bi bi-chevron-down"></i>
                </div>
                <div class="user-dropdown">
                    <div class="user-dropdown-header">
                        <strong th:text="${session.usuarioNombre}">Usuario</strong>
                        <p th:text="${session.usuario.correo}">email@example.com</p>
                    </div>
                    <div class="user-dropdown-menu">
                        <a href="/user-account">
                            <i class="bi bi-person"></i> Mi cuenta
                        </a>
                        <a href="/alquiler/mis-alquileres">
                            <i class="bi bi-calendar-check"></i> Mis alquileres
                        </a>
                        <div class="user-dropdown-divider"></div>
                        <a href="/logout" class="logout-link">
                            <i class="bi bi-box-arrow-right"></i> Cerrar sesión
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Botón de notificaciones de pago (campanita) -->
            <button class="payment-bell-btn" id="paymentBellBtn" th:if="${session.usuario}" aria-label="Notificaciones de pago" title="Notificaciones de pago">
                <i class="bi bi-bell-fill"></i>
                <span class="payment-notification-badge" id="paymentNotificationBadge" style="display: none;">0</span>
            </button>
            
            <!-- Botón del carrito -->
            <button class="cart-btn-header" onclick="toggleCart()" aria-label="Ver carrito" title="Ver carrito de compras">
                <i class="bi bi-cart3"></i>
                <span class="cart-badge" id="cartBadge" style="display: none;">0</span>
            </button>
            
            <!-- Botón de cambio de tema -->
            <button class="theme-toggle-btn" aria-label="Cambiar tema" title="Cambiar entre modo claro y oscuro">
                <i class="bi bi-moon-fill"></i>
            </button>
            
            <!-- Botón de login si no hay sesión -->
            <a th:unless="${session.usuario}" href="/login" class="login-btn">
                <i class="bi bi-person-circle"></i> Iniciar sesión
            </a>
        </div>
    </header>

    <!-- Page Header -->
    <section class="page-header">
        <div class="page-header-overlay"></div>
        <div class="container">
            <h1 class="page-title">Catálogo de mobiliario</h1>
            <p class="page-breadcrumb"><a href="/">Inicio</a> / Alquilar</p>
        </div>
    </section>

    <!-- Store Content -->
    <main class="content-principal container">
        <div class="section-header">
            <h2 class="section-title">Mobiliario Disponible</h2>
            <p class="section-subtitle">Encuentra el mobiliario perfecto para tu evento especial</p>
        </div>

        <!-- Filter Section -->
        <div class="store-filters-modern">
            <!-- Search Box -->
            <div class="search-box-modern">
                <div class="search-input-wrapper">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" id="searchProduct" placeholder="Buscar mobiliario por nombre, descripción o categoría..." autocomplete="off">
                    <button class="btn-clear-search-modern" id="clearSearchBtn" style="display: none;" onclick="clearSearch()">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                </div>
            </div>
            
            <!-- Filters Row -->
            <div class="filters-row-modern">
                <div class="filter-item-modern">
                    <label><i class="bi bi-tag"></i> Categoría</label>
                    <select id="categoryFilter" class="select-modern">
                        <option value="">Todas las categorías</option>
                        <option th:each="categoria : ${categorias}" 
                                th:value="${#strings.toLowerCase(categoria.nombre)}" 
                                th:text="${categoria.nombre}">Categoría</option>
                    </select>
                </div>
                
                <div class="filter-item-modern">
                    <label><i class="bi bi-box-seam"></i> Disponibilidad</label>
                    <select id="stockFilter" class="select-modern">
                        <option value="">Todos</option>
                        <option value="available">Con Stock</option>
                        <option value="unavailable">Sin Stock</option>
                    </select>
                </div>
                
                <div class="filter-item-modern">
                    <label><i class="bi bi-sort-down"></i> Ordenar por</label>
                    <select id="sortBy" class="select-modern">
                        <option value="default">Por defecto</option>
                        <option value="name-asc">Nombre: A-Z</option>
                        <option value="name-desc">Nombre: Z-A</option>
                        <option value="price-asc">Precio: Menor a Mayor</option>
                        <option value="price-desc">Precio: Mayor a Menor</option>
                    </select>
                </div>
                
                <button class="btn-reset-filters-modern" onclick="resetAllFilters()">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>Limpiar</span>
                </button>
            </div>
            
            <!-- Results Info -->
            <div class="results-info-modern" id="resultsInfo">
                <i class="bi bi-info-circle"></i>
                <span id="resultsText">Cargando productos...</span>
            </div>
        </div>

        <!-- Products Grid -->
        <div class="products-list" id="productsList">
            <!-- Productos dinámicos desde la base de datos -->
            <div class="product-card-modern" th:each="producto : ${productos}"
                 th:data-name="${producto.nombreProducto}"
                 th:data-description="${producto.descripcionProducto}"
                 th:data-category="${producto.categoriaProducto}"
                 th:data-price="${producto.precioProducto}"
                 th:data-stock="${producto.stock}"
                 th:data-has-stock="${producto.stock != null && producto.stock > 0}"
                 th:classappend="${producto.stock == null || producto.stock <= 0 ? 'product-out-of-stock' : ''}">
                
                <!-- Checkbox de selección múltiple -->
                <input type="checkbox" 
                       class="multi-select-checkbox" 
                       th:data-producto-id="${producto.id}"
                       th:data-producto-nombre="${producto.nombreProducto}"
                       th:data-producto-precio="${producto.precioProducto}"
                       th:data-stock="${producto.stock}"
                       th:disabled="${producto.stock == null || producto.stock <= 0}"
                       onchange="handleProductSelection(this)"
                       title="Seleccionar para añadir al carrito">
                
                <!-- Imagen del producto -->
                <div class="product-card-image-wrapper">
                    <div class="product-card-image-container">
                        <img th:src="${producto.imagenProducto != null ? producto.imagenProducto : '/img/producto-default.jpg'}" 
                             th:alt="${producto.nombreProducto}"
                             class="product-card-image"
                             th:classappend="${producto.stock == null || producto.stock <= 0 ? 'out-of-stock-filter' : ''}">
                        
                        <!-- Badge de categoría -->
                        <div class="product-card-category-badge" th:if="${producto.categoriaProducto}">
                            <i class="bi bi-tag-fill"></i>
                            <span th:text="${producto.categoriaProducto}">Categoría</span>
                        </div>
                        
                        <!-- Botón de zoom -->
                        <button class="product-card-zoom-btn" 
                                th:if="${producto.stock != null && producto.stock > 0}"
                                onclick="viewImageFromParent(this)"
                                title="Ver imagen completa">
                            <i class="bi bi-zoom-in"></i>
                        </button>
                        
                        <!-- Overlay de sin stock -->
                        <div class="product-card-no-stock-overlay" th:if="${producto.stock == null || producto.stock <= 0}">
                            <div class="product-card-no-stock-badge">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <span>AGOTADO</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido del producto -->
                <div class="product-card-content">
                    <!-- Título -->
                    <h3 class="product-card-title" th:text="${producto.nombreProducto}">Nombre del Producto</h3>
                    
                    <!-- Descripción -->
                    <p class="product-card-description" th:text="${producto.descripcionProducto}">Descripción del producto que puede ser un poco larga</p>
                    
                    <!-- Rating Stars -->
                    <div class="product-rating-container" th:attr="data-producto-id=${producto.id}">
                        <div class="product-stars-wrapper">
                            <div class="product-stars">
                                <span class="product-star">★</span>
                                <span class="product-star">★</span>
                                <span class="product-star">★</span>
                                <span class="product-star">★</span>
                                <span class="product-star">★</span>
                            </div>
                            <span class="product-rating-number">0.0</span>
                        </div>
                        <button class="btn-ver-resenas" th:attr="data-producto-id=${producto.id},data-producto-nombre=${producto.nombreProducto}" onclick="abrirPanelResenas(this)">
                            <i class="bi bi-chat-left-text"></i>
                            <span class="resenas-count">(0)</span>
                        </button>
                    </div>
                    
                    <!-- Stock badge con botón de favoritos -->
                    <div class="product-card-stock-info">
                        <div class="product-card-stock-badge" 
                             th:classappend="${producto.stock != null && producto.stock > 0 ? 'stock-ok' : 'stock-out'}">
                            <i th:class="${producto.stock != null && producto.stock > 0 ? 'bi bi-check-circle-fill' : 'bi bi-x-circle-fill'}"></i>
                            <span th:text="${producto.stock != null && producto.stock > 0 ? producto.stock + ' disponibles' : 'Sin stock'}">Stock</span>
                        </div>
                        
                        <!-- Botón de favoritos reubicado ultra moderno -->
                        <button class="product-card-favorite-btn-new" 
                                th:data-producto-id="${producto.id}"
                                th:data-has-stock="${producto.stock != null && producto.stock > 0}"
                                th:disabled="${producto.stock == null || producto.stock <= 0}"
                                onclick="toggleFavorito(this)"
                                th:title="${producto.stock != null && producto.stock > 0 ? 'Agregar a favoritos' : 'Producto sin stock'}">
                            <i class="bi bi-heart"></i>
                        </button>
                    </div>
                    
                    <!-- Precio y acción -->
                    <div class="product-card-footer">
                        <div class="product-card-price-box">
                            <span class="product-card-price-amount" th:text="${'$' + #numbers.formatDecimal(producto.precioProducto, 1, 'POINT', 2, 'COMMA')}">$0</span>
                            <span class="product-card-price-period">/ día</span>
                        </div>
                        
                        <button class="product-card-add-btn" 
                                th:data-producto-id="${producto.id}"
                                th:data-stock="${producto.stock}"
                                th:disabled="${producto.stock == null || producto.stock <= 0}"
                                th:classappend="${producto.stock == null || producto.stock <= 0 ? 'disabled' : ''}"
                                onclick="agregarAlCarrito(this)">
                            <i class="bi bi-cart-plus-fill"></i>
                            <span th:text="${producto.stock != null && producto.stock > 0 ? 'Añadir' : 'Agotado'}">Añadir</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mensaje si no hay productos -->
            <div class="no-products" th:if="${#lists.isEmpty(productos)}">
                <i class="bi bi-inbox"></i>
                <h3>No hay productos disponibles</h3>
                <p>En este momento no tenemos mobiliario disponible. Por favor, vuelve más tarde o contáctanos para consultas especiales.</p>
                <div class="no-products-actions">
                    <a href="/" class="btn btn-primary"><i class="bi bi-house"></i> Volver al Inicio</a>
                    <a href="/contact" class="btn btn-secondary"><i class="bi bi-envelope"></i> Contactar</a>
                </div>
            </div>
        </div>
        
        <!-- Botón ver más / ver menos -->
        <div class="load-more-container" id="loadMoreContainer" style="display: none;">
            <button class="btn-load-more" id="btnLoadMore" onclick="loadMoreProducts()">
                <span class="load-more-text">Ver más productos</span>
                <i class="bi bi-chevron-down"></i>
            </button>
            <button class="btn-load-less" id="btnLoadLess" onclick="loadLessProducts()" style="display: none;">
                <span class="load-less-text">Ver menos productos</span>
                <i class="bi bi-chevron-up"></i>
            </button>
            <p class="load-more-info" id="loadMoreInfo">Mostrando <span id="shownCount">8</span> de <span id="totalCount">0</span> productos</p>
        </div>

        <!-- Stats Section -->
        <section class="store-stats" th:if="${!#lists.isEmpty(productos)}">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <div class="stat-content">
                        <h4 th:text="${#lists.size(productos)}">0</h4>
                        <p>Productos Disponibles</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="bi bi-truck"></i>
                    </div>
                    <div class="stat-content">
                        <h4>Entrega</h4>
                        <p>Gratis en Bogotá</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="stat-content">
                        <h4>Garantía</h4>
                        <p>100% Calidad</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="bi bi-headset"></i>
                    </div>
                    <div class="stat-content">
                        <h4>Soporte</h4>
                        <p>24/7 Disponible</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="store-cta">
            <div class="cta-content">
                <h2>¿No encuentras lo que buscas?</h2>
                <p>Contáctanos y te ayudaremos a encontrar el mobiliario perfecto para tu evento</p>
                <div class="cta-buttons">
                    <a href="/contact" class="btn btn-primary"><i class="bi bi-telephone"></i> Contactar Ahora</a>
                    <a href="/gallery" class="btn btn-secondary"><i class="bi bi-images"></i> Ver Galería</a>
                </div>
            </div>
        </section>
    </main>

    <!-- Barra flotante de selección múltiple -->
    <div class="multi-select-action-bar" id="multiSelectBar">
        <div class="multi-select-info">
            <i class="bi bi-bag-check-fill"></i>
            <span>Productos seleccionados:</span>
            <span class="multi-select-count" id="selectedCount">0</span>
        </div>
        <div class="multi-select-actions">
            <button class="btn-add-selected" onclick="addSelectedToCart()">
                <i class="bi bi-cart-check-fill"></i>
                <span>Añadir al Carrito</span>
            </button>
            <button class="btn-clear-selection" onclick="clearAllSelections()" title="Limpiar selección">
                <i class="bi bi-trash-fill"></i>
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-main">
            <div class="grid-footer container">
                <div class="footer-column">
                    <div class="footer-logo">
                        <i class="bi bi-house-heart"></i>
                        <span>Furniture <strong>Rental</strong></span>
                    </div>
                    <p class="footer-description">Transformamos tus eventos con mobiliario de alta calidad y servicio excepcional.</p>
                    <div class="footer-social">
                        <a href="#"><i class="bi bi-facebook"></i></a>
                        <a href="#"><i class="bi bi-instagram"></i></a>
                        <a href="#"><i class="bi bi-twitter"></i></a>
                        <a href="#"><i class="bi bi-linkedin"></i></a>
                    </div>
                </div>

                <div class="footer-column">
                    <h3>Categorías</h3>
                    <nav class="footer-menu">
                        <a href="#"><i class="bi bi-chevron-right"></i> Eventos Corporativos</a>
                        <a href="#"><i class="bi bi-chevron-right"></i> Bodas y Celebraciones</a>
                        <a href="#"><i class="bi bi-chevron-right"></i> Fiestas Infantiles</a>
                        <a href="#"><i class="bi bi-chevron-right"></i> Quinceañeros</a>    
                    </nav>
                </div>

                <div class="footer-column">
                    <h3>Sobre nosotros</h3>
                    <nav class="footer-menu">
                        <a href="/about"><i class="bi bi-chevron-right"></i> Nuestra historia</a>
                        <a href="#"><i class="bi bi-chevron-right"></i> Misión y visión</a>
                        <a href="#"><i class="bi bi-chevron-right"></i> Política de Privacidad</a>
                        <a href="#"><i class="bi bi-chevron-right"></i> Términos y Condiciones</a>
                    </nav>
                </div>

                <div class="footer-column">
                    <h3>Contacto</h3>
                    <nav class="footer-menu">
                        <a href="#"><i class="bi bi-telephone"></i> +57 300 123 4567</a>
                        <a href="#"><i class="bi bi-envelope"></i> info@furniturerent.com</a>
                        <a href="#"><i class="bi bi-geo-alt"></i> Bogotá, Colombia</a>
                        <a href="#"><i class="bi bi-clock"></i> Lun - Sáb: 8am - 6pm</a>
                    </nav>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="container">
                <p class="copyright">© 2024 FURENT. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Vista Previa del Carrito -->
    <div th:replace="~{fragments/cart-preview :: cart-preview}"></div>

    <!-- Modal de Imagen -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <div class="image-modal-content" onclick="event.stopPropagation()">
            <button class="image-modal-close" onclick="closeImageModal()">
                <i class="bi bi-x-lg"></i>
            </button>
            <img id="modalImage" src="" alt="">
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Funciones para el modal de imagen
        function viewImageFromParent(button) {
            const container = button.closest('.product-card-image-container');
            const img = container.querySelector('.product-card-image');
            const imageSrc = img.src;
            const productName = img.alt;
            
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = imageSrc;
            modalImg.alt = productName;
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Cerrar con tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });
    </script>
    <script th:src="@{/js/format-utils.js}"></script>
    <script th:src="@{/js/cart-preview.js}"></script>
    <script>

        // Agregar producto al carrito
        function agregarAlCarrito(boton) {
            // Verificar si el botón está deshabilitado
            if (boton.disabled || boton.classList.contains('btn-disabled')) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Producto sin stock',
                    text: 'Este producto no está disponible en este momento',
                    confirmButtonColor: '#8cbc00'
                });
                return;
            }
            
            const productoId = boton.getAttribute('data-producto-id');
            const stockDisponible = parseInt(boton.getAttribute('data-stock')) || 0;
            
            Swal.fire({
                title: 'Cantidad a Alquilar',
                input: 'number',
                inputLabel: `¿Cuántas unidades deseas alquilar? (Disponibles: ${stockDisponible})`,
                inputValue: 1,
                inputAttributes: {
                    min: 1,
                    max: stockDisponible,
                    step: 1
                },
                showCancelButton: true,
                confirmButtonText: 'Agregar al Carrito',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#8cbc00',
                preConfirm: (cantidad) => {
                    if (!cantidad || cantidad < 1) {
                        Swal.showValidationMessage('Debes ingresar al menos 1 unidad');
                        return false;
                    }
                    if (cantidad > stockDisponible) {
                        Swal.showValidationMessage(`Solo hay ${stockDisponible} unidades disponibles`);
                        return false;
                    }
                    return cantidad;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const cantidad = result.value;
                    
                    boton.disabled = true;
                    const textoOriginal = boton.innerHTML;
                    boton.innerHTML = '<i class="bi bi-hourglass-split"></i> Agregando...';

                    fetch('/carrito/agregar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `productoId=${productoId}&cantidad=${cantidad}&diasAlquiler=1`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Agregado!',
                                text: data.message,
                                timer: 2000,
                                showConfirmButton: false
                            });
                            // Actualizar badge del carrito en el header
                            if (typeof updateCartBadge === 'function') {
                                updateCartBadge();
                            }
                            // Animar el botón del carrito en el header
                            const cartBtn = document.querySelector('.cart-btn-header');
                            if (cartBtn) {
                                cartBtn.style.animation = 'none';
                                setTimeout(() => {
                                    cartBtn.style.animation = 'cartShake 0.5s ease';
                                }, 10);
                            }
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonColor: '#8cbc00'
                            });
                        }
                        boton.disabled = false;
                        boton.innerHTML = textoOriginal;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al agregar el producto',
                            confirmButtonColor: '#8cbc00'
                        });
                        boton.disabled = false;
                        boton.innerHTML = textoOriginal;
                    });
                }
            });
        }

        // ========== SISTEMA DE SELECCIÓN MÚLTIPLE ==========
        
        let selectedProducts = new Set();
        
        // Manejar selección individual de producto
        function handleProductSelection(checkbox) {
            const card = checkbox.closest('.product-card-modern');
            const productoId = checkbox.getAttribute('data-producto-id');
            
            if (checkbox.checked) {
                selectedProducts.add(productoId);
                card.classList.add('selected');
            } else {
                selectedProducts.delete(productoId);
                card.classList.remove('selected');
            }
            
            updateSelectionUI();
        }
        
        // Seleccionar/Deseleccionar todos
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.multi-select-checkbox:not(:disabled)');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
                handleProductSelection(checkbox);
            });
            
            // Actualizar texto del botón
            const btnText = document.getElementById('selectAllText');
            const btnIcon = document.querySelector('.btn-select-all i');
            
            if (!allChecked) {
                btnText.textContent = 'Deseleccionar Todos';
                btnIcon.className = 'bi bi-check-square-fill';
            } else {
                btnText.textContent = 'Seleccionar Todos';
                btnIcon.className = 'bi bi-check-square';
            }
        }
        
        // Actualizar UI de selección
        function updateSelectionUI() {
            const count = selectedProducts.size;
            const actionBar = document.getElementById('multiSelectBar');
            const countSpan = document.getElementById('selectedCount');
            
            // Validar que los elementos existan
            if (!actionBar || !countSpan) {
                console.warn('Elementos de selección no encontrados en el DOM');
                return;
            }
            
            countSpan.textContent = count;
            
            if (count > 0) {
                actionBar.classList.add('active');
            } else {
                actionBar.classList.remove('active');
                // Resetear botón seleccionar todos
                const selectAllText = document.getElementById('selectAllText');
                const selectAllIcon = document.querySelector('.btn-select-all i');
                
                if (selectAllText) {
                    selectAllText.textContent = 'Seleccionar Todos';
                }
                if (selectAllIcon) {
                    selectAllIcon.className = 'bi bi-check-square';
                }
            }
        }
        
        // Limpiar todas las selecciones
        function clearAllSelections(silent = false) {
            const checkboxes = document.querySelectorAll('.multi-select-checkbox:checked');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const card = checkbox.closest('.product-card-modern');
                if (card) {
                    card.classList.remove('selected');
                }
            });
            
            selectedProducts.clear();
            updateSelectionUI();
            
            // Solo mostrar mensaje si no es silencioso
            if (!silent) {
                Swal.fire({
                    icon: 'info',
                    title: '<strong style="color: #0c5460;">🗑️ Selección limpiada</strong>',
                    html: `
                        <div style="padding: 15px; background: linear-gradient(135deg, rgba(23,162,184,0.1), rgba(17,122,139,0.1)); border-radius: 12px; border-left: 5px solid #17a2b8;">
                            <p style="margin: 0; font-size: 15px; color: #6b7280;">
                                Se han deseleccionado todos los productos
                            </p>
                        </div>
                    `,
                    timer: 1800,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'animate__animated animate__fadeOut animate__delay-1s'
                    }
                });
            }
        }
        
        // Añadir productos seleccionados al carrito
        async function addSelectedToCart() {
            console.log('🛒 Iniciando proceso de añadir productos al carrito');
            console.log('📦 Productos seleccionados:', selectedProducts.size);
            
            if (selectedProducts.size === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No hay productos seleccionados',
                    text: 'Por favor selecciona al menos un producto',
                    confirmButtonColor: '#8cbc00'
                });
                return;
            }
            
            // Obtener información de productos seleccionados
            const productosInfo = [];
            selectedProducts.forEach(productoId => {
                const checkbox = document.querySelector(`.multi-select-checkbox[data-producto-id="${productoId}"]`);
                if (checkbox) {
                    const card = checkbox.closest('.product-card-modern');
                    const descripcion = card ? card.querySelector('.product-card-description')?.textContent : '';
                    
                    productosInfo.push({
                        id: productoId,
                        nombre: checkbox.getAttribute('data-producto-nombre'),
                        descripcion: descripcion,
                        precio: checkbox.getAttribute('data-producto-precio'),
                        stock: parseInt(checkbox.getAttribute('data-stock'))
                    });
                }
            });
            
            // Detectar modo oscuro
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            // Crear lista HTML de productos con nombre y descripción
            let productosHTML = `
                <style>
                    @keyframes slideInLeft {
                        from { opacity: 0; transform: translateX(-30px); }
                        to { opacity: 1; transform: translateX(0); }
                    }
                    @keyframes fadeInScale {
                        from { opacity: 0; transform: scale(0.95); }
                        to { opacity: 1; transform: scale(1); }
                    }
                    @keyframes shimmerEffect {
                        0% { background-position: -200% center; }
                        100% { background-position: 200% center; }
                    }
                    @keyframes badgePulse {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.1); }
                    }
                    @keyframes iconBounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-3px); }
                    }
                    .product-scroll::-webkit-scrollbar { width: 8px; }
                    .product-scroll::-webkit-scrollbar-track { 
                        background: ${isDarkMode ? 'rgba(30,41,59,0.5)' : 'rgba(226,232,240,0.5)'}; 
                        border-radius: 4px; 
                    }
                    .product-scroll::-webkit-scrollbar-thumb { 
                        background: linear-gradient(135deg, #8cbc00, #037bc0); 
                        border-radius: 4px; 
                        transition: background 0.3s; 
                    }
                    .product-scroll::-webkit-scrollbar-thumb:hover { 
                        background: linear-gradient(135deg, #6fa000, #025d91); 
                    }
                </style>
                <div class="product-scroll" style="max-height: 320px; overflow-y: auto; text-align: left; margin-top: 10px; padding-right: 8px;">
            `;
            
            productosInfo.forEach((producto, index) => {
                productosHTML += `
                    <div style="position: relative; padding: 10px 12px; margin-bottom: 8px; background: ${isDarkMode ? 'rgba(30,41,59,0.7)' : 'rgba(140,188,0,0.08)'}; border-radius: 10px; border-left: 3px solid #8cbc00; overflow: hidden; animation: slideInLeft 0.4s ease ${index * 0.08}s both; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.background='${isDarkMode ? 'rgba(30,41,59,0.9)' : 'rgba(140,188,0,0.12)'}'; this.style.transform='translateX(3px)'; this.style.boxShadow='0 4px 16px ${isDarkMode ? 'rgba(0,0,0,0.4)' : 'rgba(140,188,0,0.2)'}'" onmouseout="this.style.background='${isDarkMode ? 'rgba(30,41,59,0.7)' : 'rgba(140,188,0,0.08)'}'; this.style.transform='translateX(0)'; this.style.boxShadow='none'">
                        <!-- Shimmer effect -->
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, ${isDarkMode ? 'rgba(140,188,0,0.1)' : 'rgba(255,255,255,0.2)'}, transparent); background-size: 200% 100%; animation: shimmerEffect 3s linear infinite ${index * 0.5}s;"></div>
                        
                        <!-- Badge de número -->
                        <div style="position: absolute; top: 8px; right: 10px; background: linear-gradient(135deg, #8cbc00, #037bc0); color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; box-shadow: 0 2px 8px rgba(140,188,0,0.35); animation: badgePulse 2s ease-in-out infinite;">
                            ${index + 1}
                        </div>
                        
                        <!-- Contenido del producto -->
                        <div style="position: relative; padding-right: 34px;">
                            <!-- Nombre del producto -->
                            <div style="font-weight: 700; color: ${isDarkMode ? '#f1f5f9' : '#1f2937'}; margin-bottom: 5px; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                                <i class="bi bi-box-seam-fill" style="color: #8cbc00; font-size: 16px; animation: iconBounce 2s ease-in-out infinite;"></i>
                                <span>${producto.nombre}</span>
                            </div>
                            
                            <!-- Descripción -->
                            <div style="font-size: 11px; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; margin-bottom: 6px; line-height: 1.4; padding-left: 22px;">
                                ${producto.descripcion || 'Sin descripción disponible'}
                            </div>
                            
                            <!-- Precio y Stock -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center; padding-left: 22px;">
                                <span style="background: linear-gradient(135deg, #8cbc00, #6fa000); color: white; padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 12px; box-shadow: 0 2px 6px rgba(140,188,0,0.3); display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="bi bi-cash-coin"></i>
                                    $${parseFloat(producto.precio).toFixed(2)} / día
                                </span>
                                <span style="background: ${isDarkMode ? 'rgba(3,123,192,0.25)' : 'rgba(3,123,192,0.15)'}; color: ${isDarkMode ? '#60a5fa' : '#037bc0'}; padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 11px; display: inline-flex; align-items: center; gap: 4px; border: 1px solid ${isDarkMode ? 'rgba(3,123,192,0.3)' : 'rgba(3,123,192,0.2)'};">
                                    <i class="bi bi-boxes"></i>
                                    Stock: ${producto.stock}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });
            productosHTML += `</div>`;
            
            const { value: formValues } = await Swal.fire({
                title: `
                    <style>
                        @keyframes titleSlideIn {
                            from { opacity: 0; transform: translateY(-10px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        @keyframes cartPulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.1); }
                        }
                    </style>
                    <div style="animation: titleSlideIn 0.5s ease;">
                        <strong style="background: linear-gradient(135deg, #8cbc00, #037bc0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 22px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <i class="bi bi-cart-plus-fill" style="background: linear-gradient(135deg, #8cbc00, #037bc0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: cartPulse 2s ease-in-out infinite; display: inline-block;"></i>
                            <span>Añadir Productos al Carrito</span>
                        </strong>
                    </div>
                `,
                html: `
                    <style>
                        @keyframes inputFocus {
                            0% { box-shadow: 0 0 0 0 rgba(140,188,0,0.4); }
                            50% { box-shadow: 0 0 0 6px rgba(140,188,0,0); }
                            100% { box-shadow: 0 0 0 0 rgba(140,188,0,0); }
                        }
                    </style>
                    
                    <!-- Header de selección -->
                    <div style="position: relative; background: ${isDarkMode ? 'rgba(30,41,59,0.8)' : 'linear-gradient(135deg, rgba(140,188,0,0.12), rgba(3,123,192,0.12))'}; padding: 10px 14px; border-radius: 8px; margin-bottom: 12px; border: 2px solid ${isDarkMode ? 'rgba(140,188,0,0.25)' : 'rgba(140,188,0,0.3)'}; overflow: hidden; animation: fadeInScale 0.4s ease;">
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, ${isDarkMode ? 'rgba(140,188,0,0.08)' : 'rgba(255,255,255,0.3)'}, transparent); background-size: 200% 100%; animation: shimmerEffect 2.5s linear infinite;"></div>
                        <p style="position: relative; color: ${isDarkMode ? '#f1f5f9' : '#1f2937'}; margin: 0; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="bi bi-check-circle-fill" style="color: #8cbc00; font-size: 18px; animation: badgePulse 2s ease-in-out infinite;"></i>
                            Has seleccionado <strong style="color: #8cbc00; font-size: 16px; margin: 0 4px; animation: badgePulse 2s ease-in-out infinite;">${selectedProducts.size}</strong> producto(s)
                        </p>
                    </div>
                    
                    ${productosHTML}
                    
                    <!-- Panel de cantidad -->
                    <div style="margin-top: 12px; padding: 12px 14px; background: ${isDarkMode ? 'rgba(30,41,59,0.7)' : 'linear-gradient(135deg, rgba(140,188,0,0.06), rgba(3,123,192,0.06))'}; border-radius: 8px; border: 2px solid ${isDarkMode ? 'rgba(140,188,0,0.25)' : 'rgba(140,188,0,0.25)'}; animation: fadeInScale 0.5s ease;">
                        <label for="swal-input-cantidad" style="display: flex; align-items: center; gap: 6px; font-weight: 700; color: ${isDarkMode ? '#f1f5f9' : '#1f2937'}; margin-bottom: 8px; font-size: 13px;">
                            <i class="bi bi-calculator-fill" style="color: #8cbc00; font-size: 16px; animation: iconBounce 2s ease-in-out infinite;"></i>
                            Cantidad por producto:
                        </label>
                        <input id="swal-input-cantidad" class="swal2-input" type="number" min="1" value="1" 
                               style="margin: 0; width: 100%; max-width: 180px; font-size: 16px; font-weight: 700; text-align: center; border: 2px solid #8cbc00; border-radius: 8px; padding: 8px 10px; background: ${isDarkMode ? '#1e293b' : '#ffffff'}; color: ${isDarkMode ? '#f1f5f9' : '#1f2937'}; transition: all 0.3s ease;"
                               onfocus="this.style.animation='inputFocus 0.6s ease'; this.style.transform='scale(1.05)'"
                               onblur="this.style.animation=''; this.style.transform='scale(1)'">
                        <div style="font-size: 11px; color: ${isDarkMode ? '#94a3b8' : '#64748b'}; margin-top: 6px; display: flex; align-items: center; gap: 5px; justify-content: center;">
                            <i class="bi bi-info-circle-fill" style="color: #8cbc00;"></i>
                            <span>Se añadirá esta cantidad de <strong style="color: ${isDarkMode ? '#f1f5f9' : '#1f2937'};">cada producto</strong></span>
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '<i class="bi bi-cart-check-fill"></i> Añadir al Carrito',
                cancelButtonText: '<i class="bi bi-x-circle"></i> Cancelar',
                confirmButtonColor: '#8cbc00',
                cancelButtonColor: '#dc2626',
                width: '620px',
                background: isDarkMode ? '#1e293b' : '#ffffff',
                color: isDarkMode ? '#f1f5f9' : '#1f2937',
                customClass: {
                    confirmButton: 'swal2-confirm-modern',
                    cancelButton: 'swal2-cancel-modern',
                    popup: 'animate__animated animate__bounceIn animate__faster'
                },
                backdrop: `rgba(0,0,0,${isDarkMode ? '0.75' : '0.5'})`,
                preConfirm: () => {
                    const cantidad = document.getElementById('swal-input-cantidad').value;
                    if (!cantidad || cantidad < 1) {
                        Swal.showValidationMessage('La cantidad debe ser al menos 1');
                        return false;
                    }
                    return { cantidad: parseInt(cantidad) };
                }
            });
            
            if (formValues) {
                const cantidad = formValues.cantidad;
                
                // VALIDACIÓN PREVIA: Verificar stock ANTES de intentar añadir
                const productosConProblemas = [];
                const productosValidos = [];
                
                for (const producto of productosInfo) {
                    if (cantidad > producto.stock) {
                        productosConProblemas.push({
                            nombre: producto.nombre,
                            stockDisponible: producto.stock,
                            cantidadSolicitada: cantidad
                        });
                    } else {
                        productosValidos.push(producto);
                    }
                }
                
                // Si hay productos con problemas, mostrar advertencia compacta y moderna
                if (productosConProblemas.length > 0) {
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    const result = await Swal.fire({
                        icon: false,
                        title: '',
                        html: `
                            <style>
                                @keyframes fadeInUp {
                                    from { opacity: 0; transform: translateY(10px); }
                                    to { opacity: 1; transform: translateY(0); }
                                }
                                @keyframes scaleIn {
                                    from { opacity: 0; transform: scale(0.9); }
                                    to { opacity: 1; transform: scale(1); }
                                }
                                @keyframes gentlePulse {
                                    0%, 100% { transform: scale(1); box-shadow: 0 2px 6px rgba(245,158,11,0.25); }
                                    50% { transform: scale(1.05); box-shadow: 0 4px 12px rgba(245,158,11,0.4); }
                                }
                                @keyframes badgeBounce {
                                    0%, 100% { transform: scale(1) rotate(0deg); }
                                    25% { transform: scale(1.1) rotate(-5deg); }
                                    75% { transform: scale(1.1) rotate(5deg); }
                                }
                                @keyframes shimmer {
                                    0% { background-position: -200% center; }
                                    100% { background-position: 200% center; }
                                }
                                @keyframes iconGlow {
                                    0%, 100% { filter: drop-shadow(0 0 2px rgba(251,191,36,0.3)); }
                                    50% { filter: drop-shadow(0 0 8px rgba(251,191,36,0.6)); }
                                }
                                @keyframes slideInRight {
                                    from { opacity: 0; transform: translateX(-15px); }
                                    to { opacity: 1; transform: translateX(0); }
                                }
                                @keyframes numberPop {
                                    0% { transform: scale(0.8); opacity: 0; }
                                    50% { transform: scale(1.1); }
                                    100% { transform: scale(1); opacity: 1; }
                                }
                                @keyframes borderPulse {
                                    0%, 100% { border-color: ${isDarkMode ? 'rgba(245,158,11,0.15)' : 'rgba(245,158,11,0.2)'}; }
                                    50% { border-color: ${isDarkMode ? 'rgba(245,158,11,0.4)' : 'rgba(245,158,11,0.5)'}; }
                                }
                                .modal-scroll::-webkit-scrollbar { width: 6px; }
                                .modal-scroll::-webkit-scrollbar-track { background: ${isDarkMode ? 'rgba(30,41,59,0.4)' : 'rgba(226,232,240,0.4)'}; border-radius: 3px; }
                                .modal-scroll::-webkit-scrollbar-thumb { background: ${isDarkMode ? 'rgba(245,158,11,0.4)' : 'rgba(245,158,11,0.3)'}; border-radius: 3px; transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
                                .modal-scroll::-webkit-scrollbar-thumb:hover { background: ${isDarkMode ? 'rgba(245,158,11,0.6)' : 'rgba(245,158,11,0.5)'}; }
                            </style>
                            <div style="padding: 16px; animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
                                <!-- Header compacto con animaciones modernas -->
                                <div style="position: relative; background: ${isDarkMode ? 'rgba(30,41,59,0.8)' : 'rgba(254,243,199,0.5)'}; padding: 10px 14px; border-radius: 8px; border-left: 4px solid #f59e0b; margin-bottom: 12px; animation: fadeInUp 0.4s ease; overflow: hidden;">
                                    <!-- Efecto shimmer de fondo -->
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, ${isDarkMode ? 'rgba(251,191,36,0.1)' : 'rgba(251,191,36,0.15)'}, transparent); background-size: 200% 100%; animation: shimmer 3s linear infinite;"></div>
                                    
                                    <div style="position: relative; display: flex; align-items: center; gap: 10px;">
                                        <div style="position: relative; flex-shrink: 0;">
                                            <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 8px; display: flex; align-items: center; justify-content: center; animation: gentlePulse 2s ease-in-out infinite;">
                                                <i class="bi bi-exclamation-triangle-fill" style="color: white; font-size: 16px; animation: iconGlow 2s ease-in-out infinite;"></i>
                                            </div>
                                            <div style="position: absolute; top: -4px; right: -4px; min-width: 16px; height: 16px; padding: 0 3px; background: linear-gradient(135deg, #dc2626, #991b1b); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 9px; border: 2px solid ${isDarkMode ? '#1e293b' : '#ffffff'}; animation: badgeBounce 2s ease-in-out infinite; box-shadow: 0 2px 8px rgba(220,38,38,0.4);">
                                                ${productosConProblemas.length}
                                            </div>
                                        </div>
                                        <div style="flex: 1; min-width: 0; animation: slideInRight 0.5s ease;">
                                            <h3 style="color: ${isDarkMode ? '#fbbf24' : '#b45309'}; font-size: 14px; font-weight: 700; margin: 0; letter-spacing: -0.2px;">
                                                Stock Insuficiente
                                            </h3>
                                            <p style="color: ${isDarkMode ? '#94a3b8' : '#64748b'}; font-size: 11px; margin: 0; font-weight: 500;">
                                                ${productosConProblemas.length} producto${productosConProblemas.length > 1 ? 's' : ''} sin disponibilidad
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lista de productos -->
                                <div style="margin-bottom: 12px;">
                                    <div class="modal-scroll" style="max-height: 140px; overflow-y: auto; padding-right: 6px;">
                                        ${productosConProblemas.map((p, i) => `
                                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; margin-bottom: 8px; background: ${isDarkMode ? 'rgba(30,41,59,0.6)' : 'rgba(254,243,199,0.35)'}; border-radius: 8px; border: 1px solid ${isDarkMode ? 'rgba(245,158,11,0.15)' : 'rgba(245,158,11,0.2)'}; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); animation: fadeInUp 0.4s ease ${i * 0.05}s backwards; cursor: default;" onmouseover="this.style.background='${isDarkMode ? 'rgba(30,41,59,0.9)' : 'rgba(254,243,199,0.55)'}'; this.style.borderColor='${isDarkMode ? 'rgba(245,158,11,0.35)' : 'rgba(245,158,11,0.4)'}'; this.style.transform='translateY(-2px) scale(1.01)'; this.style.boxShadow='0 6px 16px ${isDarkMode ? 'rgba(0,0,0,0.4)' : 'rgba(245,158,11,0.2)'}'" onmouseout="this.style.background='${isDarkMode ? 'rgba(30,41,59,0.6)' : 'rgba(254,243,199,0.35)'}'; this.style.borderColor='${isDarkMode ? 'rgba(245,158,11,0.15)' : 'rgba(245,158,11,0.2)'}'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='none'">
                                                <div style="display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0;">
                                                    <div style="width: 28px; height: 28px; background: ${isDarkMode ? 'rgba(245,158,11,0.15)' : 'rgba(245,158,11,0.1)'}; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.3s ease;">
                                                        <i class="bi bi-box" style="color: #f59e0b; font-size: 14px;"></i>
                                                    </div>
                                                    <span style="color: ${isDarkMode ? '#f1f5f9' : '#1e293b'}; font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.nombre}</span>
                                                </div>
                                                <div style="display: flex; gap: 14px; flex-shrink: 0; align-items: center;">
                                                    <div style="text-align: center;">
                                                        <div style="color: ${isDarkMode ? '#64748b' : '#94a3b8'}; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 2px;">Pedido</div>
                                                        <div style="color: #dc2626; font-size: 15px; font-weight: 700; line-height: 1; animation: numberPop 0.5s ease ${i * 0.05 + 0.2}s backwards;">${p.cantidadSolicitada}</div>
                                                    </div>
                                                    <div style="width: 1px; height: 22px; background: ${isDarkMode ? 'rgba(245,158,11,0.2)' : 'rgba(245,158,11,0.25)'}; border-radius: 1px;"></div>
                                                    <div style="text-align: center;">
                                                        <div style="color: ${isDarkMode ? '#64748b' : '#94a3b8'}; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 2px;">Stock</div>
                                                        <div style="color: #10b981; font-size: 15px; font-weight: 700; line-height: 1; animation: numberPop 0.5s ease ${i * 0.05 + 0.25}s backwards;">${p.stockDisponible}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Bloque de Disponibles con animaciones -->
                                ${productosValidos.length > 0 ? `
                                    <div style="position: relative; background: ${isDarkMode ? 'rgba(16,185,129,0.12)' : 'rgba(16,185,129,0.1)'}; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(16,185,129,0.25); margin-bottom: 8px; animation: fadeInUp 0.5s ease; overflow: hidden;">
                                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(16,185,129,0.15), transparent); background-size: 200% 100%; animation: shimmer 3s linear infinite 0.5s;"></div>
                                        <div style="position: relative; display: flex; align-items: center; justify-content: space-between;">
                                            <span style="color: ${isDarkMode ? '#6ee7b7' : '#047857'}; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                                <i class="bi bi-check-circle-fill" style="font-size: 14px; animation: iconGlow 2s ease-in-out infinite;"></i>
                                                <span>Disponibles</span>
                                            </span>
                                            <div style="min-width: 26px; height: 26px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; box-shadow: 0 2px 6px rgba(16,185,129,0.25); animation: numberPop 0.6s ease 0.5s backwards;">
                                                ${productosValidos.length}
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Bloque de Tip con animación de brillo -->
                                <div style="position: relative; background: ${isDarkMode ? 'rgba(140,188,0,0.1)' : 'rgba(140,188,0,0.08)'}; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(140,188,0,0.22); animation: fadeInUp 0.6s ease; overflow: hidden;">
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(140,188,0,0.12), transparent); background-size: 200% 100%; animation: shimmer 3s linear infinite 1s;"></div>
                                    <p style="position: relative; margin: 0; color: ${isDarkMode ? '#cbd5e1' : '#475569'}; font-size: 12px; display: flex; align-items: center; gap: 8px; line-height: 1.4;">
                                        <i class="bi bi-lightbulb-fill" style="color: #8cbc00; font-size: 14px; flex-shrink: 0; animation: iconGlow 2s ease-in-out infinite 0.5s;"></i>
                                        <span><strong style="color: ${isDarkMode ? '#e2e8f0' : '#1e293b'};">Tip:</strong> Ajusta cantidades o deselecciona ítems sin stock</span>
                                    </p>
                                </div>
                            </div>
                        `,
                        showCancelButton: productosValidos.length > 0,
                        confirmButtonText: productosValidos.length > 0 ? '<i class="bi bi-cart-plus"></i> Añadir disponibles' : '<i class="bi bi-check-lg"></i> OK',
                        cancelButtonText: '<i class="bi bi-x-lg"></i> Cancelar',
                        confirmButtonColor: '#8cbc00',
                        cancelButtonColor: '#6b7280',
                        customClass: {
                            popup: 'animate__animated animate__bounceIn animate__faster',
                            confirmButton: 'swal2-confirm-modern',
                            cancelButton: 'swal2-cancel-modern'
                        },
                        buttonsStyling: true,
                        background: isDarkMode ? '#1e293b' : '#ffffff',
                        color: isDarkMode ? '#f1f5f9' : '#1e293b',
                        width: '480px',
                        padding: '0',
                        backdrop: `rgba(0,0,0,${isDarkMode ? '0.7' : '0.4'})`
                    });
                    
                    // Si no hay productos válidos o el usuario cancela, salir
                    if (productosValidos.length === 0 || !result.isConfirmed) {
                        return;
                    }
                    
                    // Continuar solo con productos válidos
                    productosInfo = productosValidos;
                }
                
                // Proceder a añadir productos al carrito
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Mostrar loading con animación mejorada
                const loadingSwal = Swal.fire({
                    title: '<strong style="color: #1f2937;">Procesando...</strong>',
                    html: `
                        <div style="text-align: center; padding: 20px;">
                            <div style="display: inline-block; position: relative;">
                                <i class="bi bi-cart-check-fill" style="font-size: 64px; color: #8cbc00; animation: cartBounce 1s infinite;"></i>
                                <div style="position: absolute; top: -10px; right: -10px; width: 30px; height: 30px; background: linear-gradient(135deg, #8cbc00, #037bc0); border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: countPulse 1.5s infinite;">
                                    <i class="bi bi-check2" style="color: white; font-size: 18px; font-weight: bold;"></i>
                                </div>
                            </div>
                            <p style="margin-top: 20px; color: #6b7280; font-size: 16px; font-weight: 600;">Añadiendo ${productosInfo.length} producto(s) al carrito...</p>
                            <p style="color: #8cbc00; font-size: 14px; margin-top: 10px;">Por favor espera un momento</p>
                        </div>
                        <style>
                            @keyframes cartBounce {
                                0%, 100% { transform: translateY(0); }
                                50% { transform: translateY(-15px); }
                            }
                        </style>
                    `,
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    background: 'linear-gradient(135deg, rgba(140,188,0,0.05), rgba(3,123,192,0.05))',
                    customClass: {
                        popup: 'animate__animated animate__fadeIn'
                    }
                });
                
                // Añadir cada producto al carrito
                for (const producto of productosInfo) {
                    console.log(`📦 Procesando: ${producto.nombre} (ID: ${producto.id})`);

                    
                    try {
                        console.log(`🔄 Enviando petición para ${producto.nombre}...`);
                        const response = await fetch('/carrito/agregar', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'Accept': 'application/json'
                            },
                            body: `productoId=${encodeURIComponent(producto.id)}&cantidad=${encodeURIComponent(cantidad)}&diasAlquiler=1`
                        });
                        
                        console.log(`📡 Status de respuesta para ${producto.nombre}:`, response.status);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`❌ Error HTTP ${response.status}:`, errorText);
                            throw new Error(`Error del servidor (${response.status})`);
                        }
                        
                        // Verificar que la respuesta sea JSON
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error(`❌ Respuesta no es JSON:`, text.substring(0, 200));
                            throw new Error('El servidor no respondió con datos válidos');
                        }
                        
                        const data = await response.json();
                        console.log(`📡 Respuesta JSON para ${producto.nombre}:`, data);
                        
                        if (data.success) {
                            console.log(`✅ ${producto.nombre} añadido exitosamente`);
                            successCount++;
                        } else {
                            console.error(`❌ Error al añadir ${producto.nombre}:`, data.message);
                            errors.push(`${producto.nombre}: ${data.message || 'Error desconocido'}`);
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`💥 Excepción al añadir ${producto.nombre}:`, error);
                        errors.push(`${producto.nombre}: ${error.message || 'Error de conexión'}`);
                        errorCount++;
                    }
                    
                    // Pequeña pausa entre peticiones para evitar sobrecarga
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Actualizar badge del carrito
                if (typeof updateCartBadge === 'function') {
                    updateCartBadge();
                }
                
                // Animar botón del carrito
                const cartBtn = document.querySelector('.cart-btn-header');
                if (cartBtn && successCount > 0) {
                    cartBtn.style.animation = 'none';
                    setTimeout(() => {
                        cartBtn.style.animation = 'cartShake 0.5s ease';
                    }, 10);
                }
                
                // Limpiar selecciones (silenciosamente, sin mostrar mensaje)
                clearAllSelections(true);
                
                // Cerrar el modal de carga
                Swal.close();
                
                // Mostrar resultado con animaciones mejoradas
                if (successCount > 0 && errorCount === 0) {
                    Swal.fire({
                        icon: 'success',
                        title: '<strong style="color: #155724;">¡Éxito Total!</strong>',
                        html: `
                            <div style="padding: 15px; background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(56,142,60,0.1)); border-radius: 12px; border-left: 5px solid #4caf50;">
                                <p style="font-size: 16px; margin: 0;">
                                    Se añadieron <strong style="color: #4caf50; font-size: 20px;">${successCount}</strong> producto(s) al carrito exitosamente.
                                </p>
                            </div>
                        `,
                        confirmButtonColor: '#8cbc00',
                        confirmButtonText: '<i class="bi bi-check-circle-fill"></i> ¡Perfecto!',
                        customClass: {
                            popup: 'animate__animated animate__bounceIn'
                        }
                    });
                } else if (successCount > 0 && errorCount > 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: '<strong style="color: #856404;">⚠️ Parcialmente completado</strong>',
                        html: `
                            <div style="padding: 15px; background: linear-gradient(135deg, rgba(76,175,80,0.1), rgba(56,142,60,0.1)); border-radius: 12px; margin-bottom: 15px; border-left: 5px solid #4caf50;">
                                <p style="margin: 0;">✅ Añadidos: <strong style="color: #4caf50;">${successCount}</strong> producto(s)</p>
                            </div>
                            <div style="padding: 15px; background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(185,28,28,0.1)); border-radius: 12px; border-left: 5px solid #dc2626;">
                                <p style="margin: 0 0 10px 0; font-weight: 700; color: #dc2626;">
                                    ❌ Errores (${errorCount}):
                                </p>
                                <div style="text-align: left; font-size: 13px; color: #6b7280;">
                                    ${errors.map(e => `<div style="margin: 5px 0;">• ${e}</div>`).join('')}
                                </div>
                            </div>
                        `,
                        confirmButtonColor: '#8cbc00',
                        confirmButtonText: '<i class="bi bi-check-circle"></i> Entendido',
                        customClass: {
                            popup: 'animate__animated animate__headShake'
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '<strong style="color: #721c24;">❌ Error al añadir productos</strong>',
                        html: `
                            <div style="padding: 15px; background: linear-gradient(135deg, rgba(220,38,38,0.1), rgba(185,28,28,0.1)); border-radius: 12px; border-left: 5px solid #dc2626;">
                                <div style="text-align: left; font-size: 14px; color: #6b7280;">
                                    ${errors.map(e => `<div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 8px;">• ${e}</div>`).join('')}
                                </div>
                            </div>
                        `,
                        confirmButtonColor: '#dc2626',
                        confirmButtonText: '<i class="bi bi-x-circle"></i> Cerrar',
                        customClass: {
                            popup: 'animate__animated animate__shakeX'
                        }
                    });
                }
            }
        }

        // ========== FILTROS Y BÚSQUEDA MEJORADOS ==========
        
        // Variable global para guardar el orden original de productos
        let originalProductsOrder = [];
        
        // Variables para paginación
        let currentlyShown = 8;
        const productsPerPage = 8;

        document.addEventListener('DOMContentLoaded', function() {
            // Cargar contador del carrito
            actualizarContadorCarrito();
            
            // Cargar estado de favoritos
            cargarEstadoFavoritos();
            
            // Guardar el orden original de los productos
            const allProducts = document.querySelectorAll('.product-card-modern');
            originalProductsOrder = Array.from(allProducts);
            
            // Inicializar paginación
            initializePagination();
            
            // Inicializar filtros
            initializeFilters();
            
            // Actualizar contador inicial de resultados
            updateResultsInfo();
        });
        
        // ========== FUNCIONES DE PAGINACIÓN ==========
        
        function initializePagination() {
            const allProducts = document.querySelectorAll('.product-card-modern');
            const totalProducts = allProducts.length;
            
            if (totalProducts > productsPerPage) {
                // Ocultar productos después del límite inicial
                allProducts.forEach((product, index) => {
                    if (index >= productsPerPage) {
                        product.style.display = 'none';
                        product.classList.add('hidden-product');
                    } else {
                        product.style.display = 'block';
                        product.classList.remove('hidden-product');
                    }
                });
                
                // Mostrar botón "Ver más"
                updateLoadMoreButton();
            } else {
                // Si hay 8 o menos productos, ocultar el botón
                document.getElementById('loadMoreContainer').style.display = 'none';
                
                // Mostrar todos los productos
                allProducts.forEach(product => {
                    product.style.display = 'block';
                    product.classList.remove('hidden-product');
                });
            }
        }
        
        function loadMoreProducts() {
            const allProducts = document.querySelectorAll('.product-card-modern');
            const visibleProducts = Array.from(allProducts).filter(p => !p.classList.contains('hidden-product'));
            const hiddenProducts = Array.from(allProducts).filter(p => p.classList.contains('hidden-product'));
            
            // Mostrar los siguientes 8 productos
            const productsToShow = hiddenProducts.slice(0, productsPerPage);
            
            productsToShow.forEach((product, index) => {
                setTimeout(() => {
                    product.style.display = 'block';
                    product.classList.remove('hidden-product');
                    product.style.animation = 'fadeInUp 0.6s ease-out';
                }, index * 100);
            });
            
            currentlyShown = visibleProducts.length + productsToShow.length;
            
            // Actualizar botón
            updateLoadMoreButton();
            
            // Scroll suave al primer producto nuevo
            if (productsToShow.length > 0) {
                setTimeout(() => {
                    productsToShow[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        }
        
        function loadLessProducts() {
            const allProducts = document.querySelectorAll('.product-card-modern');
            const visibleProducts = Array.from(allProducts).filter(p => !p.classList.contains('hidden-product'));
            
            // Calcular cuántos productos ocultar (todos excepto los primeros 8)
            const productsToHide = visibleProducts.slice(productsPerPage);
            
            if (productsToHide.length > 0) {
                // Scroll suave al inicio de los productos antes de ocultar
                const firstProduct = allProducts[0];
                if (firstProduct) {
                    firstProduct.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                // Ocultar productos con animación
                setTimeout(() => {
                    productsToHide.forEach((product, index) => {
                        setTimeout(() => {
                            product.style.animation = 'fadeOut 0.4s ease-out';
                            setTimeout(() => {
                                product.style.display = 'none';
                                product.classList.add('hidden-product');
                            }, 400);
                        }, index * 50);
                    });
                }, 500);
                
                // Actualizar contador después de las animaciones
                setTimeout(() => {
                    currentlyShown = productsPerPage;
                    updateLoadMoreButton();
                }, 500 + (productsToHide.length * 50) + 400);
            }
        }
        
        // Agregar animación fadeOut al CSS inline
        const fadeOutStyle = document.createElement('style');
        fadeOutStyle.textContent = `
            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-20px);
                }
            }
        `;
        document.head.appendChild(fadeOutStyle);
        
        function updateLoadMoreButton() {
            const allProducts = document.querySelectorAll('.product-card-modern');
            const totalProducts = allProducts.length;
            const hiddenProducts = Array.from(allProducts).filter(p => p.classList.contains('hidden-product'));
            const shownProducts = totalProducts - hiddenProducts.length;
            
            const loadMoreContainer = document.getElementById('loadMoreContainer');
            const btnLoadMore = document.getElementById('btnLoadMore');
            const btnLoadLess = document.getElementById('btnLoadLess');
            const shownCountSpan = document.getElementById('shownCount');
            const totalCountSpan = document.getElementById('totalCount');
            
            shownCountSpan.textContent = shownProducts;
            totalCountSpan.textContent = totalProducts;
            
            // Si hay productos ocultos, mostrar botón "Ver más"
            if (hiddenProducts.length > 0) {
                loadMoreContainer.style.display = 'flex';
                btnLoadMore.style.display = 'flex';
                btnLoadLess.style.display = 'none';
            } 
            // Si todos están visibles y hay más de 8, mostrar botón "Ver menos"
            else if (shownProducts > productsPerPage) {
                loadMoreContainer.style.display = 'flex';
                btnLoadMore.style.display = 'none';
                btnLoadLess.style.display = 'flex';
            }
            // Si hay 8 o menos productos, ocultar todo
            else {
                loadMoreContainer.style.display = 'none';
            }
        }
        
        function initializeFilters() {
            const searchInput = document.getElementById('searchProduct');
            const categoryFilter = document.getElementById('categoryFilter');
            const stockFilter = document.getElementById('stockFilter');
            const sortBy = document.getElementById('sortBy');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    if (this.value.length > 0) {
                        clearSearchBtn.style.display = 'flex';
                    } else {
                        clearSearchBtn.style.display = 'none';
                    }
                    applyFilters();
                });
            }
            
            if (categoryFilter) {
                categoryFilter.addEventListener('change', applyFilters);
            }
            
            if (stockFilter) {
                stockFilter.addEventListener('change', applyFilters);
            }
            
            if (sortBy) {
                sortBy.addEventListener('change', applySorting);
            }
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchProduct')?.value.toLowerCase().trim() || '';
            const category = document.getElementById('categoryFilter')?.value.toLowerCase().trim() || '';
            const stockFilter = document.getElementById('stockFilter')?.value || '';
            const productsList = document.getElementById('productsList');
            
            // Verificar si no hay filtros activos
            const noFiltersActive = searchTerm === '' && category === '' && stockFilter === '';
            
            if (noFiltersActive) {
                // Si no hay filtros, restaurar orden original y mostrar todos
                originalProductsOrder.forEach(product => {
                    productsList.appendChild(product);
                });
                
                const allProducts = document.querySelectorAll('.product-card-modern');
                allProducts.forEach((product, index) => {
                    // Limpiar todos los estilos inline que puedan interferir
                    product.style.removeProperty('display');
                    product.style.removeProperty('visibility');
                    product.style.removeProperty('height');
                    product.style.removeProperty('margin');
                    product.style.removeProperty('padding');
                    
                    // Forzar visibilidad inmediata
                    product.style.display = 'block';
                    product.style.visibility = 'visible';
                    product.style.opacity = '1';
                    product.style.transform = 'translateY(0)';
                    product.style.transition = 'none';
                });
                
                updateResultsInfo();
                return;
            }
            
            // Si hay filtros activos, proceder con el filtrado
            const products = Array.from(document.querySelectorAll('.product-card-modern'));
            let visibleCount = 0;
            const matchedProducts = [];
            const unmatchedProducts = [];
            
            // Clasificar productos en coincidentes y no coincidentes
            products.forEach(product => {
                const productName = (product.dataset.name || '').toLowerCase();
                const productDescription = (product.dataset.description || '').toLowerCase();
                const productCategory = (product.dataset.category || '').toLowerCase();
                const hasStock = product.dataset.hasStock === 'true';
                
                // Filtro de búsqueda (busca en nombre, descripción y categoría)
                const matchesSearch = searchTerm === '' || 
                    productName.includes(searchTerm) ||
                    productDescription.includes(searchTerm) ||
                    productCategory.includes(searchTerm);
                
                // Filtro de categoría
                const matchesCategory = category === '' || productCategory.includes(category);
                
                // Filtro de stock
                let matchesStock = true;
                if (stockFilter === 'available') {
                    matchesStock = hasStock;
                } else if (stockFilter === 'unavailable') {
                    matchesStock = !hasStock;
                }
                
                // Clasificar producto
                if (matchesSearch && matchesCategory && matchesStock) {
                    matchedProducts.push(product);
                    visibleCount++;
                } else {
                    unmatchedProducts.push(product);
                }
            });
            
            // Reordenar en el DOM: productos coincidentes primero, luego los que no coinciden
            matchedProducts.forEach(product => productsList.appendChild(product));
            unmatchedProducts.forEach(product => productsList.appendChild(product));
            
            // Mostrar productos coincidentes inmediatamente
            matchedProducts.forEach((product, index) => {
                product.style.removeProperty('display');
                product.style.display = 'block';
                product.style.visibility = 'visible';
                product.style.opacity = '1';
                product.style.transform = 'translateY(0)';
                product.style.transition = 'none';
            });
            
            // Ocultar productos que no coinciden inmediatamente
            unmatchedProducts.forEach(product => {
                product.style.display = 'none';
                product.style.opacity = '0';
                product.style.visibility = 'hidden';
            });
            
            updateResultsInfo(visibleCount);
            
            // Aplicar ordenamiento inmediatamente
            applySorting();
        }
        
        function applySorting() {
            const sortBy = document.getElementById('sortBy')?.value || 'default';
            const productsList = document.getElementById('productsList');
            const products = Array.from(document.querySelectorAll('.product-card-modern'));
            const visibleProducts = products.filter(p => p.style.display !== 'none');
            
            if (sortBy === 'default') {
                return;
            }
            
            visibleProducts.sort((a, b) => {
                switch(sortBy) {
                    case 'name-asc':
                        return (a.dataset.name || '').localeCompare(b.dataset.name || '');
                    case 'name-desc':
                        return (b.dataset.name || '').localeCompare(a.dataset.name || '');
                    case 'price-asc':
                        return parseFloat(a.dataset.price || 0) - parseFloat(b.dataset.price || 0);
                    case 'price-desc':
                        return parseFloat(b.dataset.price || 0) - parseFloat(a.dataset.price || 0);
                    default:
                        return 0;
                }
            });
            
            // Reordenar productos en el DOM
            visibleProducts.forEach(product => {
                productsList.appendChild(product);
            });
        }
        
        function updateResultsInfo(visibleCount) {
            const resultsText = document.getElementById('resultsText');
            const resultsInfo = document.getElementById('resultsInfo');
            const totalProducts = document.querySelectorAll('.product-card-modern').length;
            const count = visibleCount !== undefined ? visibleCount : totalProducts;
            
            if (count === 0) {
                resultsText.innerHTML = `<strong>¡No se encontraron productos!</strong> Intenta con otros criterios de búsqueda`;
                resultsInfo.style.borderLeftColor = '#ef4444';
                resultsInfo.querySelector('i').style.color = '#ef4444';
            } else if (count === totalProducts) {
                resultsText.innerHTML = `<strong>${totalProducts}</strong> productos disponibles`;
                resultsInfo.style.borderLeftColor = '#8cbc00';
                resultsInfo.querySelector('i').style.color = '#8cbc00';
            } else {
                resultsText.innerHTML = `<strong>${count}</strong> de <strong>${totalProducts}</strong> productos encontrados`;
                resultsInfo.style.borderLeftColor = '#037bc0';
                resultsInfo.querySelector('i').style.color = '#037bc0';
            }
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('searchProduct');
            const clearBtn = document.getElementById('clearSearchBtn');
            
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
            }
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
            
            applyFilters();
        }
        
        function resetAllFilters() {
            // Limpiar todos los campos
            document.getElementById('searchProduct').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('stockFilter').value = '';
            document.getElementById('sortBy').value = 'default';
            document.getElementById('clearSearchBtn').style.display = 'none';
            
            const productsList = document.getElementById('productsList');
            
            // Restaurar el orden original de los productos
            originalProductsOrder.forEach(product => {
                productsList.appendChild(product);
            });
            
            // Mostrar todos los productos inmediatamente
            const products = document.querySelectorAll('.product-card-modern');
            products.forEach(product => {
                product.style.removeProperty('display');
                product.style.removeProperty('visibility');
                product.style.removeProperty('height');
                product.style.removeProperty('margin');
                product.style.removeProperty('padding');
                
                product.style.display = 'block';
                product.style.visibility = 'visible';
                product.style.opacity = '1';
                product.style.transform = 'translateY(0)';
                product.style.transition = 'none';
            });
            
            updateResultsInfo();
            
            // Animación de confirmación
            const resultsInfo = document.getElementById('resultsInfo');
            resultsInfo.style.animation = 'none';
            setTimeout(() => {
                resultsInfo.style.animation = 'fadeIn 0.5s ease';
            }, 10);
            
            // Mensaje de confirmación
            Swal.fire({
                icon: 'success',
                title: 'Filtros restablecidos',
                text: 'Mostrando todos los productos en orden original',
                timer: 1500,
                showConfirmButton: false,
                position: 'top-end',
                toast: true
            });
        }

        // ========== FUNCIONES DE FAVORITOS ==========

        // Cargar estado de favoritos al inicio
        function cargarEstadoFavoritos() {
            fetch('/favoritos/list-ids')
                .then(response => response.json())
                .then(data => {
                    const favoritosIds = data.ids || [];
                    
                    // Convertir todos los IDs a strings para comparación consistente
                    const favoritosIdsStr = favoritosIds.map(id => String(id));
                    
                    // Marcar los productos que están en favoritos
                    document.querySelectorAll('.product-card-favorite-btn-new').forEach(btn => {
                        const productoId = String(btn.getAttribute('data-producto-id'));
                        const icon = btn.querySelector('i');
                        
                        if (favoritosIdsStr.includes(productoId)) {
                            // Agregar clase active para el estilo
                            btn.classList.add('active');
                            
                            // Cambiar icono a lleno
                            if (icon) {
                                icon.classList.remove('bi-heart');
                                icon.classList.add('bi-heart-fill');
                            }
                            
                            btn.title = 'Quitar de favoritos';
                        } else {
                            // Asegurar que no esté marcado
                            btn.classList.remove('active');
                            
                            // Cambiar icono a vacío
                            if (icon) {
                                icon.classList.remove('bi-heart-fill');
                                icon.classList.add('bi-heart');
                            }
                            
                            btn.title = 'Agregar a favoritos';
                        }
                    });
                })
                .catch(error => console.error('Error al cargar favoritos:', error));
        }

        // Toggle favorito (agregar/quitar)
        function toggleFavorito(button) {
            // Verificar si el producto tiene stock
            const hasStock = button.getAttribute('data-has-stock') === 'true';
            
            if (!hasStock || button.disabled) {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    width: '280px',
                    padding: '10px',
                    customClass: {
                        title: 'toast-title-compact'
                    },
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                });
                
                Toast.fire({
                    icon: 'warning',
                    title: 'Producto sin stock',
                    background: '#f59e0b',
                    color: '#fff',
                    iconColor: '#fff'
                });
                return;
            }
            
            const productoId = button.getAttribute('data-producto-id');
            const icon = button.querySelector('i');
            const isActive = button.classList.contains('active');
            
            // Deshabilitar temporalmente el botón para evitar clicks múltiples
            button.disabled = true;
            
            fetch('/favoritos/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `productoId=${productoId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.action === 'added') {
                        // Agregar a favoritos
                        button.classList.add('active');
                        button.classList.add('animating');
                        
                        // Cambiar icono si no está lleno
                        if (icon.classList.contains('bi-heart')) {
                            icon.classList.remove('bi-heart');
                            icon.classList.add('bi-heart-fill');
                        }
                        
                        button.title = 'Quitar de favoritos';
                        
                        // Trigger animations
                        icon.style.animation = 'none';
                        setTimeout(() => {
                            icon.style.animation = 'heartBeat 0.6s ease';
                            setTimeout(() => button.classList.remove('animating'), 600);
                        }, 10);
                        
                        // Mostrar notificación toast moderna
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            width: '280px',
                            padding: '10px',
                            customClass: {
                                title: 'toast-title-compact'
                            },
                            didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        });
                        
                        Toast.fire({
                            icon: 'success',
                            title: '¡Agregado a favoritos!',
                            background: '#10b981',
                            color: '#fff',
                            iconColor: '#fff'
                        });
                    } else {
                        // Quitar de favoritos
                        button.classList.remove('active');
                        
                        // Cambiar icono a vacío
                        if (icon.classList.contains('bi-heart-fill')) {
                            icon.classList.remove('bi-heart-fill');
                            icon.classList.add('bi-heart');
                        }
                        
                        button.title = 'Agregar a favoritos';
                        
                        // Reset animation
                        icon.style.animation = 'none';
                        
                        // Mostrar notificación toast moderna
                        const Toast = Swal.mixin({
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 2000,
                            timerProgressBar: true,
                            width: '280px',
                            padding: '10px',
                            customClass: {
                                title: 'toast-title-compact'
                            },
                            didOpen: (toast) => {
                                toast.addEventListener('mouseenter', Swal.stopTimer)
                                toast.addEventListener('mouseleave', Swal.resumeTimer)
                            }
                        });
                        
                        Toast.fire({
                            icon: 'info',
                            title: 'Eliminado de favoritos',
                            background: '#6b7280',
                            color: '#fff',
                            iconColor: '#fff'
                        });
                    }
                } else if (data.requireLogin) {
                    // Usuario no logueado
                    Swal.fire({
                        icon: 'warning',
                        title: 'Inicia sesión',
                        text: data.message,
                        confirmButtonColor: '#8cbc00',
                        confirmButtonText: 'Iniciar Sesión',
                        showCancelButton: true,
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/login';
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#8cbc00'
                    });
                }
                
                // Re-habilitar el botón
                button.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error al procesar favorito',
                    confirmButtonColor: '#8cbc00'
                });
                
                // Re-habilitar el botón
                button.disabled = false;
            });
        }
        
        // ========== CARGAR CALIFICACIONES DE PRODUCTOS ==========
        
        async function cargarCalificacionesProductos() {
            const productCards = document.querySelectorAll('.product-rating-container');
            
            for (const container of productCards) {
                const productoId = container.getAttribute('data-producto-id');
                if (!productoId) continue;
                
                try {
                    const response = await fetch(`/resenas/estadisticas/${productoId}`);
                    const data = await response.json();
                    
                    if (data.success && data.estadisticas) {
                        const { promedioCalificacion, totalResenas } = data.estadisticas;
                        actualizarEstrellas(container, promedioCalificacion, totalResenas);
                        actualizarBotonResenas(productoId, totalResenas);
                    }
                } catch (error) {
                    console.error(`Error al cargar calificación del producto ${productoId}:`, error);
                }
            }
        }
        
        function actualizarBotonResenas(productoId, totalResenas) {
            const button = document.querySelector(`.btn-ver-resenas[data-producto-id="${productoId}"]`);
            if (!button) return;
            
            const countSpan = button.querySelector('.resenas-count');
            if (countSpan) {
                countSpan.textContent = `(${totalResenas})`;
            }
            
            if (totalResenas === 0) {
                button.classList.add('sin-resenas');
                button.disabled = true;
                button.title = 'Sin reseñas aún';
            } else {
                button.classList.remove('sin-resenas');
                button.disabled = false;
                button.title = 'Ver reseñas';
            }
        }
        
        // ========== PANEL MODAL DE RESEÑAS ==========
        
        async function abrirPanelResenas(button) {
            const productoId = button.getAttribute('data-producto-id');
            const productoNombre = button.getAttribute('data-producto-nombre');
            
            if (!productoId) return;
            
            // Actualizar título
            document.getElementById('panelProductoNombre').textContent = productoNombre;
            
            // Mostrar modal
            const modal = document.getElementById('resenaspanelModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            
            // Cargar reseñas
            await cargarResenasPanel(productoId);
        }
        
        function cerrarPanelResenas() {
            const modal = document.getElementById('resenaspanelModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
        }
        
        async function cargarResenasPanel(productoId) {
            const bodyContainer = document.getElementById('panelResenasBody');
            bodyContainer.innerHTML = '<div class="resenas-empty-state"><i class="bi bi-hourglass-split"></i><h4>Cargando...</h4></div>';
            
            try {
                const response = await fetch(`/resenas/producto/${productoId}`);
                const data = await response.json();
                
                if (!data.success || !data.resenas || data.resenas.length === 0) {
                    mostrarSinResenas(bodyContainer);
                    return;
                }
                
                // Filtrar solo reseñas aprobadas
                const resenasAprobadas = data.resenas.filter(r => r.estado === 'APROBADA');
                
                if (resenasAprobadas.length === 0) {
                    mostrarSinResenas(bodyContainer);
                    return;
                }
                
                // Actualizar contador
                document.getElementById('panelResenasCount').textContent = `${resenasAprobadas.length} reseña${resenasAprobadas.length !== 1 ? 's' : ''}`;
                
                // Mostrar reseñas
                mostrarResenasPanel(bodyContainer, resenasAprobadas);
                
            } catch (error) {
                console.error('Error al cargar reseñas:', error);
                bodyContainer.innerHTML = `
                    <div class="resenas-empty-state">
                        <i class="bi bi-exclamation-triangle"></i>
                        <h4>Error al cargar reseñas</h4>
                        <p>Por favor, inténtalo de nuevo más tarde</p>
                    </div>
                `;
            }
        }
        
        function mostrarSinResenas(container) {
            document.getElementById('panelResenasCount').textContent = '0 reseñas';
            container.innerHTML = `
                <div class="resenas-empty-state">
                    <i class="bi bi-chat-left-text"></i>
                    <h4>Sin reseñas aún</h4>
                    <p>Este producto aún no tiene reseñas. ¡Sé el primero en dejar una!</p>
                </div>
            `;
        }
        
        function mostrarResenasPanel(container, resenas) {
            const resenasHTML = resenas.map((resena, index) => {
                const estrellas = '★'.repeat(resena.calificacion) + '☆'.repeat(5 - resena.calificacion);
                const fecha = formatearFechaResena(resena.fechaCreacion);
                
                return `
                    <div class="resena-item" style="animation-delay: ${index * 0.1}s;">
                        <div class="resena-item-header">
                            <div class="resena-user-info">
                                <div class="resena-avatar">${resena.usuarioNombre.charAt(0).toUpperCase()}</div>
                                <div>
                                    <p class="resena-user-name">${resena.usuarioNombre}</p>
                                    <p class="resena-date">${fecha}</p>
                                </div>
                            </div>
                            <div class="resena-rating">
                                <div class="resena-stars">${estrellas}</div>
                                <span class="resena-score">${resena.calificacion}.0</span>
                            </div>
                        </div>
                        <div class="resena-comment">
                            <i class="bi bi-quote"></i>
                            <p>${resena.comentario}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = resenasHTML;
        }
        
        function formatearFechaResena(fechaString) {
            const fecha = new Date(fechaString);
            const ahora = new Date();
            const diffMs = ahora - fecha;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Hace un momento';
            if (diffMins < 60) return `Hace ${diffMins} minuto${diffMins !== 1 ? 's' : ''}`;
            if (diffHours < 24) return `Hace ${diffHours} hora${diffHours !== 1 ? 's' : ''}`;
            if (diffDays < 7) return `Hace ${diffDays} día${diffDays !== 1 ? 's' : ''}`;
            
            return fecha.toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'short',
                year: fecha.getFullYear() !== ahora.getFullYear() ? 'numeric' : undefined
            });
        }
        
        // Cerrar modal con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('resenaspanelModal');
                if (modal && modal.classList.contains('active')) {
                    cerrarPanelResenas();
                }
            }
        });
        
        function actualizarEstrellas(container, promedio, totalResenas) {
            const starsContainer = container.querySelector('.product-stars');
            const ratingNumber = container.querySelector('.product-rating-number');
            const ratingCount = container.querySelector('.product-rating-count');
            
            if (!starsContainer) return;
            
            // Limpiar estrellas
            starsContainer.innerHTML = '';
            
            if (totalResenas === 0) {
                // Sin reseñas
                container.innerHTML = `
                    <div class="product-no-rating">
                        <i class="bi bi-star"></i>
                        <span>Sin reseñas aún</span>
                    </div>
                `;
                return;
            }
            
            // Generar estrellas
            const fullStars = Math.floor(promedio);
            const hasHalfStar = (promedio % 1) >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            // Estrellas llenas
            for (let i = 0; i < fullStars; i++) {
                const star = document.createElement('span');
                star.className = 'product-star filled';
                star.textContent = '★';
                star.style.animationDelay = `${i * 0.1}s`;
                starsContainer.appendChild(star);
            }
            
            // Media estrella
            if (hasHalfStar) {
                const star = document.createElement('span');
                star.className = 'product-star half';
                star.textContent = '★';
                star.style.animationDelay = `${fullStars * 0.1}s`;
                starsContainer.appendChild(star);
            }
            
            // Estrellas vacías
            for (let i = 0; i < emptyStars; i++) {
                const star = document.createElement('span');
                star.className = 'product-star';
                star.textContent = '★';
                starsContainer.appendChild(star);
            }
            
            // Actualizar número
            if (ratingNumber) {
                ratingNumber.textContent = promedio.toFixed(1);
            }
            
            // Actualizar conteo
            if (ratingCount) {
                ratingCount.textContent = `(${totalResenas})`;
            }
            
            // Agregar badge si tiene buena calificación
            if (promedio >= 4.5 && totalResenas >= 5) {
                const badge = document.createElement('div');
                badge.className = 'product-rating-badge';
                badge.innerHTML = '<i class="bi bi-award-fill"></i> Top Rated';
                container.appendChild(badge);
            }
        }
        
        // Cargar calificaciones al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                cargarCalificacionesProductos();
            }, 500);
        });
    </script>
    
    <!-- Script de reseñas -->
    <script th:src="@{/js/resenas.js}"></script>
    
    <!-- Script de notificaciones de pago -->
    <script th:src="@{/js/payment-notifications.js}"></script>

    <!-- Botón Admin -->
    <div th:replace="~{fragments/admin-button :: admin-button}"></div>
    
    <!-- Modal Panel de Reseñas -->
    <div id="resenaspanelModal" class="resenas-panel-modal">
        <div class="resenas-panel-overlay" onclick="cerrarPanelResenas()"></div>
        <div class="resenas-panel-container">
            <div class="resenas-panel-header">
                <div class="resenas-panel-icon">
                    <i class="bi bi-chat-left-text-fill"></i>
                </div>
                <div class="resenas-panel-title">
                    <h3 id="panelProductoNombre">Reseñas del Producto</h3>
                    <p id="panelResenasCount">0 reseñas</p>
                </div>
                <button class="resenas-panel-close" onclick="cerrarPanelResenas()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="resenas-panel-body" id="panelResenasBody">
                <!-- Reseñas se cargan dinámicamente aquí -->
            </div>
        </div>
    </div>

</body>
</html>

