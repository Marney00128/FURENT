<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos | Panel de Administración</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }
        
        .sidebar {
            background: linear-gradient(to bottom, #1a1a2e, #16213e);
            color: #fff;
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            width: 250px;
        }
        
        .sidebar .brand {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar .brand h3 {
            margin: 0;
            font-weight: 600;
        }
        
        .sidebar .nav-link {
            padding: 0.8rem 1.5rem;
            color: rgba(255,255,255,0.7);
            border-radius: 0;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .sidebar .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 2rem;
        }
        
        .page-header {
            background-color: #fff;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 1rem 1.5rem;
        }
        
        .btn-primary {
            background-color: #0d6efd;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #0b5ed7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-outline-secondary {
            border-color: #6c757d;
            color: #6c757d;
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
            color: #495057;
            padding: 1rem;
        }
        
        .table td {
            padding: 1rem;
            vertical-align: middle;
        }
        
        .table tbody tr {
            transition: all 0.3s;
        }
        
        .table tbody tr:hover {
            background-color: rgba(13, 110, 253, 0.05);
        }
        
        .btn-action {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 0.5rem;
            transition: all 0.3s;
        }
        
        .btn-warning {
            background-color: #ffc107;
            border: none;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .modal-content {
            border: none;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 1.5rem;
        }
        
        .modal-footer {
            border-top: 1px solid rgba(0,0,0,0.05);
            padding: 1.5rem;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .form-control, .form-select {
            padding: 0.75rem 1rem;
            border-radius: 5px;
            border: 1px solid #ced4da;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .user-profile {
            background-color: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 1rem;
        }
        
        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .badge {
            padding: 0.5rem 0.75rem;
            border-radius: 30px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-auto sidebar">
                <div class="brand">
                    <h3 class="text-primary">FURENT</h3>
                    <p class="text-muted mb-0">Panel de Administración</p>
                </div>
                <ul class="nav flex-column mt-4">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/dashboard">
                            <i class="bi bi-speedometer2 me-2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/products">
                            <i class="bi bi-box-seam me-2"></i> Productos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/categories">
                            <i class="bi bi-tags me-2"></i> Categorías
                        </a>
                    </li>
                </ul>
                <div class="position-absolute bottom-0 start-0 w-100 p-3">
                    <div class="user-profile d-flex align-items-center mb-3">
                        <i class="bi bi-person-circle fs-4 me-2"></i>
                        <div>
                            <p class="mb-0 fw-bold">Administrador</p>
                            <small class="text-muted">Admin</small>
                        </div>
                    </div>
                    <a href="/perform_logout" class="btn btn-danger w-100">
                        <i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión
                    </a>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col main-content">
                <div class="page-header d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3 fw-bold">Panel de Administración</h1>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                                <li class="breadcrumb-item active">Productos</li>
                            </ol>
                        </nav>
                    </div>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="bi bi-house-door me-1"></i> Volver al Sitio
                    </a>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">Gestión de Productos</h5>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalProducto">
                            <i class="bi bi-plus-circle me-1"></i> Agregar Producto
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Imagen</th>
                                        <th>Nombre</th>
                                        <th>Precio</th>
                                        <th>Categoría</th>
                                        <th>Descripción</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productosTabla">
                                    <!-- Los productos se cargarán dinámicamente aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para Agregar/Editar Producto -->
                <div class="modal fade" id="modalProducto" tabindex="-1" aria-labelledby="modalProductoLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title fw-bold" id="modalProductoLabel">Agregar Producto</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="productoForm" enctype="multipart/form-data">
                                    <input type="hidden" id="productoId">
                                    <div class="mb-3">
                                        <label for="nombreProducto" class="form-label">Nombre</label>
                                        <input type="text" class="form-control" id="nombreProducto" name="nombreProducto" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="descripcionProducto" class="form-label">Descripción</label>
                                        <textarea class="form-control" id="descripcionProducto" name="descripcionProducto" rows="3" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="precioProducto" class="form-label">Precio</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="precioProducto" name="precioProducto" step="0.01" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="categoriaProducto" class="form-label">Categoría</label>
                                        <select class="form-select" id="categoriaProducto" name="categoriaProducto" required>
                                            <option value="">Selecciona una categoría</option>
                                            <option th:each="categoria : ${categorias}" 
                                                    th:value="${categoria.nombre}" 
                                                    th:text="${categoria.nombre}">Categoría</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="imagenProducto" class="form-label">Imagen</label>
                                        <input type="file" class="form-control" id="imagenProducto" name="imagenProducto">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="btnGuardarProducto">
                                    <i class="bi bi-save me-1"></i> Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Cargar productos al iniciar la página
            cargarProductos();
            
            // Guardar producto
            $('#btnGuardarProducto').click(function() {
                guardarProducto();
            });
            
            // Eliminar producto
            $(document).on('click', '.eliminar-producto', function() {
                const id = $(this).data('id');
                if (confirm('¿Estás seguro de eliminar este producto?')) {
                    eliminarProducto(id);
                }
            });
            
            // Editar producto
            $(document).on('click', '.editar-producto', function() {
                const id = $(this).data('id');
                cargarProductoParaEditar(id);
            });
            
            // Función para cargar productos
            function cargarProductos() {
                $.ajax({
                    url: '/admin/products/list',
                    type: 'GET',
                    success: function(data) {
                        let html = '';
                        data.forEach(function(producto) {
                            html += `
                                <tr>
                                    <td>${producto.id}</td>
                                    <td>
                                        ${producto.imagenProducto ? 
                                            `<img src="${producto.imagenProducto}" class="product-image" alt="Imagen del producto">` : 
                                            '<span class="badge bg-secondary">Sin imagen</span>'}
                                    </td>
                                    <td><strong>${producto.nombreProducto}</strong></td>
                                    <td><span class="badge bg-success">$${producto.precioProducto}</span></td>
                                    <td><span class="badge bg-info text-dark">${producto.categoriaProducto}</span></td>
                                    <td>${producto.descripcionProducto.length > 50 ? producto.descripcionProducto.substring(0, 50) + '...' : producto.descripcionProducto}</td>
                                    <td>
                                        <button class="btn btn-warning btn-action editar-producto" data-id="${producto.id}" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-danger btn-action eliminar-producto" data-id="${producto.id}" title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        $('#productosTabla').html(html);
                    },
                    error: function(error) {
                        console.error('Error al cargar productos:', error);
                        $('#productosTabla').html('<tr><td colspan="7" class="text-center text-danger">Error al cargar los productos</td></tr>');
                    }
                });
            }
            
            // Función para guardar producto
            function guardarProducto() {
                const formData = new FormData(document.getElementById('productoForm'));
                const productoId = $('#productoId').val();
                
                // URL para crear o actualizar
                const url = productoId ? `/admin/products/update/${productoId}` : '/admin/products/save';
                
                // Mostrar indicador de carga
                $('#btnGuardarProducto').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...');
                $('#btnGuardarProducto').prop('disabled', true);
                
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        // Mostrar notificación de éxito
                        const toast = `<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-success text-white">
                                    <strong class="me-auto">Éxito</strong>
                                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                                <div class="toast-body">
                                    Producto guardado correctamente
                                </div>
                            </div>
                        </div>`;
                        
                        $('body').append(toast);
                        setTimeout(function() {
                            $('.toast').toast('hide');
                        }, 3000);
                        
                        $('#modalProducto').modal('hide');
                        $('#productoForm')[0].reset();
                        $('#productoId').val(''); // Limpiar ID oculto
                        $('#modalProductoLabel').text('Agregar Producto'); // Restaurar título
                        cargarProductos();
                        
                        // Restaurar botón
                        $('#btnGuardarProducto').html('<i class="bi bi-save me-1"></i> Guardar');
                        $('#btnGuardarProducto').prop('disabled', false);
                    },
                    error: function(error) {
                        console.error('Error al guardar producto:', error);
                        
                        // Mostrar notificación de error
                        const toast = `<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-danger text-white">
                                    <strong class="me-auto">Error</strong>
                                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                                <div class="toast-body">
                                    Error al guardar el producto
                                </div>
                            </div>
                        </div>`;
                        
                        $('body').append(toast);
                        setTimeout(function() {
                            $('.toast').toast('hide');
                        }, 3000);
                        
                        // Restaurar botón
                        $('#btnGuardarProducto').html('<i class="bi bi-save me-1"></i> Guardar');
                        $('#btnGuardarProducto').prop('disabled', false);
                    }
                });
            }
            
            // Función para eliminar producto
            function eliminarProducto(id) {
                $.ajax({
                    url: `/admin/products/${id}`,
                    type: 'DELETE',
                    success: function(response) {
                        // Mostrar notificación de éxito
                        const toast = `<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-success text-white">
                                    <strong class="me-auto">Éxito</strong>
                                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                                <div class="toast-body">
                                    Producto eliminado correctamente
                                </div>
                            </div>
                        </div>`;
                        
                        $('body').append(toast);
                        setTimeout(function() {
                            $('.toast').toast('hide');
                        }, 3000);
                        
                        cargarProductos();
                    },
                    error: function(error) {
                        console.error('Error al eliminar producto:', error);
                        
                        // Mostrar notificación de error
                        const toast = `<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-danger text-white">
                                    <strong class="me-auto">Error</strong>
                                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                                <div class="toast-body">
                                    Error al eliminar el producto
                                </div>
                            </div>
                        </div>`;
                        
                        $('body').append(toast);
                        setTimeout(function() {
                            $('.toast').toast('hide');
                        }, 3000);
                    }
                });
            }
            
            // Función para cargar producto para editar
            function cargarProductoParaEditar(id) {
                $.ajax({
                    url: `/admin/products/edit/${id}`,
                    type: 'GET',
                    beforeSend: function() {
                        // Mostrar indicador de carga
                        $('#modalProductoLabel').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cargando...');
                    },
                    success: function(producto) {
                        // Cambiar el título del modal
                        $('#modalProductoLabel').text('Editar Producto');
                        
                        // Cargar datos en el formulario
                        $('#productoId').val(producto.id);
                        $('#nombreProducto').val(producto.nombreProducto);
                        $('#descripcionProducto').val(producto.descripcionProducto);
                        $('#precioProducto').val(producto.precioProducto);
                        $('#categoriaProducto').val(producto.categoriaProducto);
                        
                        // Abrir el modal
                        $('#modalProducto').modal('show');
                    },
                    error: function(error) {
                        console.error('Error al cargar producto para editar:', error);
                        
                        // Mostrar notificación de error
                        const toast = `<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-danger text-white">
                                    <strong class="me-auto">Error</strong>
                                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                                <div class="toast-body">
                                    Error al cargar el producto para editar
                                </div>
                            </div>
                        </div>`;
                        
                        $('body').append(toast);
                        setTimeout(function() {
                            $('.toast').toast('hide');
                        }, 3000);
                    }
                });
            }
            
            // Limpiar formulario al abrir el modal para agregar
            $('#modalProducto').on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                if (!button.hasClass('editar-producto')) {
                    $('#productoForm')[0].reset();
                    $('#productoId').val('');
                    $('#modalProductoLabel').text('Agregar Producto');
                }
            });
        });
    </script>
</body>
</html>