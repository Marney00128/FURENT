<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios | Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/admin-styles.css">
    <link rel="stylesheet" href="/css/admin-notifications.css">
    <link rel="stylesheet" href="/css/custom-resenas-modal.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Mejoras adicionales específicas para usuarios */
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            padding: 0 30px 30px;
            animation: fadeInUp 0.6s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stat-card-small {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .stat-card-small:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }
        
        /* Animación de iconos desactivada para evitar movimiento exagerado */
        
        /* Menu toggle button */
        .menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: var(--border-color);
        }
        
        .topbar h1 {
            color: var(--text-primary);
        }
        
        /* Espacio superior para el contenido principal */
        main.main-content > .card:first-of-type {
            margin-top: 25px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-house-heart"></i>
            <h2>FURENT <span>Admin</span></h2>
        </div>

        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </a>
            <a href="/admin/usuarios" class="nav-item active">
                <i class="bi bi-people"></i>
                <span>Usuarios</span>
            </a>
            <a href="/admin/productos" class="nav-item">
                <i class="bi bi-box-seam"></i>
                <span>Productos</span>
            </a>
            <a href="/admin/pedidos" class="nav-item">
                <i class="bi bi-cart-check"></i>
                <span>Pedidos</span>
            </a>
            <a href="/admin/categorias" class="nav-item">
                <i class="bi bi-tags"></i>
                <span>Categorías</span>
            </a>
            <a href="/admin/reportes" class="nav-item">
                <i class="bi bi-journal-text"></i>
                <span>Registros</span>
            </a>
            <a href="/admin/reportes-analytics" class="nav-item">
                <i class="bi bi-graph-up-arrow"></i>
                <span>Reportes</span>
            </a>
            <a href="/admin/configuracion" class="nav-item">
                <i class="bi bi-gear"></i>
                <span>Configuración</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="/" class="nav-item">
                <i class="bi bi-house-door"></i>
                <span>Ir al Sitio</span>
            </a>
            <a href="/logout" class="nav-item logout">
                <i class="bi bi-box-arrow-right"></i>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="bi bi-list"></i>
                </button>
                <h1>Gestión de Usuarios</h1>
            </div>

            <div class="topbar-right">
                <div class="search-box">
                    <i class="bi bi-search"></i>
                    <input type="text" placeholder="Buscar usuarios..." id="searchInput" onkeyup="filtrarUsuarios()">
                </div>

                <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
                    <i class="bi bi-moon-stars"></i>
                </button>

                <div class="user-menu">
                    <div class="user-avatar">
                        <span th:text="${#strings.substring(session.usuarioNombre, 0, 1)}">A</span>
                    </div>
                    <div class="user-info">
                        <span class="user-name" th:text="${session.usuarioNombre}">Admin</span>
                        <span class="user-role">Administrador</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Alerts -->
        <div class="alert alert-success" th:if="${mensaje}">
            <i class="bi bi-check-circle"></i>
            <span th:text="${mensaje}"></span>
        </div>

        <div class="alert alert-error" th:if="${error}">
            <i class="bi bi-exclamation-circle"></i>
            <span th:text="${error}"></span>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-header">
                <h2><i class="bi bi-people"></i> Lista de Usuarios</h2>
                <div class="header-actions">
                    <select class="filter-select" onchange="filtrarPorRol(this.value)">
                        <option value="">Todos los roles</option>
                        <option value="USER">Usuarios</option>
                        <option value="ADMIN">Administradores</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table" id="usuariosTable">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Correo</th>
                                <th>Teléfono</th>
                                <th>Rol</th>
                                <th>Último Acceso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="usuario : ${usuarios}">
                                <td>
                                    <div class="user-cell">
                                        <div class="user-avatar-small">
                                            <span th:text="${#strings.substring(usuario.nombre, 0, 1)}">U</span>
                                        </div>
                                        <span th:text="${usuario.nombre}">Usuario</span>
                                    </div>
                                </td>
                                <td th:text="${usuario.correo}">email@example.com</td>
                                <td th:text="${usuario.telefono}">+57 300 000 0000</td>
                                <td>
                                    <span class="badge" th:classappend="${usuario.rol == 'ADMIN' ? 'badge-admin' : 'badge-user'}" 
                                          th:text="${usuario.rol}">USER</span>
                                </td>
                                <td>
                                    <span th:if="${usuario.ultimoInicioSesion}" 
                                          th:text="${#temporals.format(usuario.ultimoInicioSesion, 'dd/MM/yyyy HH:mm')}">
                                        Fecha
                                    </span>
                                    <span th:unless="${usuario.ultimoInicioSesion}" class="text-muted">Nunca</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-icon btn-primary" title="Cambiar Rol" 
                                                th:data-id="${usuario.id}" 
                                                th:data-nombre="${usuario.nombre}" 
                                                th:data-rol="${usuario.rol}"
                                                onclick="cambiarRol(this.dataset.id, this.dataset.nombre, this.dataset.rol)">
                                            <i class="bi bi-shield-check"></i>
                                        </button>
                                        <button class="btn-icon btn-danger" title="Eliminar" 
                                                th:data-id="${usuario.id}" 
                                                th:data-nombre="${usuario.nombre}"
                                                onclick="confirmarEliminar(this.dataset.id, this.dataset.nombre)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(usuarios)}">
                                <td colspan="6" class="text-center">No hay usuarios registrados</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="stats-grid" style="margin-top: 30px;">
            <div class="stat-card-small">
                <i class="bi bi-people"></i>
                <div>
                    <h3 th:text="${#lists.size(usuarios)}">0</h3>
                    <p>Total Usuarios</p>
                </div>
            </div>
            <div class="stat-card-small">
                <i class="bi bi-person-check"></i>
                <div>
                    <h3 th:text="${totalUsers}">0</h3>
                    <p>Usuarios Normales</p>
                </div>
            </div>
            <div class="stat-card-small">
                <i class="bi bi-shield-check"></i>
                <div>
                    <h3 th:text="${totalAdmins}">0</h3>
                    <p>Administradores</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        console.log('=== INICIANDO SCRIPTS DE USUARIOS ===');
        
        // Asegurar funciones en scope global
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            if (sidebar) sidebar.classList.toggle('collapsed');
            if (mainContent) mainContent.classList.toggle('expanded');
        };

        // Toggle Dark Mode
        window.toggleTheme = function() {
            try {
                const body = document.body;
                const themeIcon = document.querySelector('.theme-toggle i');
                
                if (!themeIcon) {
                    console.error('Theme toggle icon not found');
                    return;
                }
                
                body.classList.toggle('dark-mode');
                
                if (body.classList.contains('dark-mode')) {
                    themeIcon.classList.remove('bi-moon-stars');
                    themeIcon.classList.add('bi-sun');
                    localStorage.setItem('adminTheme', 'dark');
                    console.log('✓ Dark mode activado');
                } else {
                    themeIcon.classList.remove('bi-sun');
                    themeIcon.classList.add('bi-moon-stars');
                    localStorage.setItem('adminTheme', 'light');
                    console.log('✓ Light mode activado');
                }
            } catch (error) {
                console.error('Error en toggleTheme:', error);
            }
        };
        
        console.log('✓ Funciones globales cargadas:', {
            toggleTheme: typeof window.toggleTheme,
            toggleSidebar: typeof window.toggleSidebar
        });

        function filtrarUsuarios() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('usuariosTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;

                for (let j = 0; j < cells.length - 1; j++) {
                    const cell = cells[j];
                    if (cell) {
                        const textValue = cell.textContent || cell.innerText;
                        if (textValue.toLowerCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }

                rows[i].style.display = found ? '' : 'none';
            }
        }

        function filtrarPorRol(rol) {
            const table = document.getElementById('usuariosTable');
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const rolCell = rows[i].getElementsByTagName('td')[3];
                if (rolCell) {
                    const rolText = rolCell.textContent.trim();
                    if (rol === '' || rolText === rol) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            }
        }

        function cambiarRol(id, nombre, rolActual) {
            console.log('=== CAMBIAR ROL LLAMADO ===');
            console.log('ID:', id);
            console.log('Nombre:', nombre);
            console.log('Rol Actual:', rolActual);
            
            if (typeof Swal === 'undefined') {
                console.error('SweetAlert2 no está disponible');
                alert('Error: No se puede mostrar el diálogo de confirmación');
                return;
            }
            
            const nuevoRol = rolActual === 'ADMIN' ? 'USER' : 'ADMIN';
            console.log('Nuevo Rol:', nuevoRol);
            
            Swal.fire({
                title: '¿Cambiar rol de usuario?',
                html: `¿Deseas cambiar el rol de <strong>${nombre}</strong> de <strong>${rolActual}</strong> a <strong>${nuevoRol}</strong>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#8cbc00',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cambiar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log('Usuario confirmó el cambio');
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/admin/usuarios/cambiar-rol/${id}`;
                    
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'nuevoRol';
                    input.value = nuevoRol;
                    
                    form.appendChild(input);
                    document.body.appendChild(form);
                    console.log('Enviando formulario...');
                    form.submit();
                } else {
                    console.log('Usuario canceló el cambio');
                }
            });
        }

        function confirmarEliminar(id, nombre) {
            console.log('=== ELIMINAR USUARIO LLAMADO ===');
            console.log('ID:', id);
            console.log('Nombre:', nombre);
            
            if (typeof Swal === 'undefined') {
                console.error('SweetAlert2 no está disponible');
                alert('Error: No se puede mostrar el diálogo de confirmación');
                return;
            }
            
            Swal.fire({
                title: '¿Eliminar usuario?',
                html: `¿Estás seguro de eliminar a <strong>${nombre}</strong>?<br><span style="color: #d33;">Esta acción no se puede deshacer.</span>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log('Usuario confirmó la eliminación');
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/admin/usuarios/eliminar/${id}`;
                    document.body.appendChild(form);
                    console.log('Enviando formulario...');
                    form.submit();
                } else {
                    console.log('Usuario canceló la eliminación');
                }
            });
        }

        // Auto-hide alerts y cargar tema
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado');
            console.log('Total de usuarios en tabla:', document.querySelectorAll('#usuariosTable tbody tr').length);
            
            // Cargar tema guardado
            const savedTheme = localStorage.getItem('adminTheme');
            const themeIcon = document.querySelector('.theme-toggle i');
            
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeIcon.classList.remove('bi-moon-stars');
                themeIcon.classList.add('bi-sun');
            }

            // Animar filas de la tabla
            const rows = document.querySelectorAll('#usuariosTable tbody tr');
            rows.forEach((row, index) => {
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                
                setTimeout(() => {
                    row.style.transition = 'all 0.5s ease';
                    row.style.opacity = '1';
                    row.style.transform = 'translateX(0)';
                }, index * 50);
            });

            // Animar cards de estadísticas
            const statCards = document.querySelectorAll('.stat-card-small');
            statCards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 300 + (index * 100));
            });
            
            setTimeout(() => {
                document.querySelectorAll('.alert').forEach(alert => {
                    alert.style.transition = 'opacity 0.3s';
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                });
            }, 5000);
        });

        // Verificar que SweetAlert2 esté cargado
        window.addEventListener('load', function() {
            if (typeof Swal !== 'undefined') {
                console.log('✓ SweetAlert2 cargado correctamente');
            } else {
                console.error('✗ SweetAlert2 NO está cargado');
            }
        });
        
        console.log('=== SCRIPTS CARGADOS ===');
    </script>
    <!-- Script de notificaciones admin -->
    <script src="/js/admin-notifications.js"></script>
</body>
</html>
